#include "StdAfx.h"
#include "ServiceUnits.h"
#include "ControlPacket.h"
#include "AttemperEngineSink.h"

//#include "Random.h"

//////////////////////////////////////////////////////////////////////////////////

//时间标识
#define IDI_LOAD_GAME_LIST			1									//加载列表
#define IDI_CONNECT_CORRESPOND		2									//重连标识
#define IDI_COLLECT_ONLINE_INFO		3									//统计在线

//////////////////////////////////////////////////////////////////////////////////

typedef unsigned int    __u16;
     typedef unsigned long   __u32;

__u16 checksum(__u16 *dp, __u16 length)
     {
	__u16 sum = 0;
	__u16	len	=	length	>>	1;

while(len-- > 0)
             sum += *dp++;
         if(length & 1)
             sum += (*dp & 0xFF00);

sum = (sum >> 16) + (sum & 0xFFFF);
         sum += (sum >> 16);
            
         len = sum & 0xFFFF;
         return(~len);
	}

//构造函数
CAttemperEngineSink::CAttemperEngineSink()
{
	//状态变量
	m_bNeekCorrespond=true;
	m_bShowServerStatus=false;

	//状态变量
	m_pInitParameter=NULL;
	m_pBindParameter=NULL;

	//组件变量
	m_pITimerEngine=NULL;
	m_pIDataBaseEngine=NULL;
	m_pITCPNetworkEngine=NULL;
	m_pITCPSocketService=NULL;

	//视频配置
	m_wAVServerPort=0;
	m_dwAVServerAddr=0;

	BYTE buf11[4];
	buf11[0] = 0x70;
	buf11[1] = 0x70;
	buf11[2] = 0x2f;
	buf11[3] = 0x70;

	int xx = checksum((__u16*)buf11, 4);

	int xxx = xx;
	return;
}

//析构函数
CAttemperEngineSink::~CAttemperEngineSink()
{
}

//接口查询
VOID * CAttemperEngineSink::QueryInterface(REFGUID Guid, DWORD dwQueryVer)
{
	QUERYINTERFACE(IAttemperEngineSink,Guid,dwQueryVer);
	QUERYINTERFACE_IUNKNOWNEX(IAttemperEngineSink,Guid,dwQueryVer);
	return NULL;
}

//启动事件
bool CAttemperEngineSink::OnAttemperEngineStart(IUnknownEx * pIUnknownEx)
{
	//绑定参数
	m_pBindParameter=new tagBindParameter[m_pInitParameter->m_wMaxConnect];
	ZeroMemory(m_pBindParameter,sizeof(tagBindParameter)*m_pInitParameter->m_wMaxConnect);

	//设置时间
	ASSERT(m_pITimerEngine!=NULL);
	m_pITimerEngine->SetTimer(IDI_COLLECT_ONLINE_INFO,m_pInitParameter->m_wCollectTime*1000L,TIMES_INFINITY,0);

	//获取目录
	TCHAR szPath[MAX_PATH]=TEXT("");
	CString szFileName;
	GetModuleFileName(AfxGetInstanceHandle(),szPath,sizeof(szPath));
	szFileName=szPath;
	int nIndex = szFileName.ReverseFind(TEXT('\\'));
	szFileName = szFileName.Left(nIndex);
	szFileName += TEXT("\\PlazaOptionConfig.ini");

	//读取配置
	m_bShowServerStatus = (GetPrivateProfileInt(TEXT("ServerStatus"),TEXT("ShowServerStatus"),0,szFileName) != 0);

	//获取目录
	TCHAR szServerAddr[LEN_SERVER]=TEXT("");
	GetCurrentDirectory(sizeof(szPath),szPath);

	//读取配置
	TCHAR szVideoFileName[MAX_PATH]=TEXT("");
	_sntprintf(szVideoFileName,CountArray(szVideoFileName),TEXT("%s\\VideoOption.ini"),szPath);
	m_wAVServerPort=GetPrivateProfileInt(TEXT("VideoOption"),TEXT("ServerPort"), 0,szVideoFileName);
	DWORD dwAddrLen=GetPrivateProfileString(TEXT("VideoOption"),TEXT("ServerAddr"), TEXT(""), szServerAddr,LEN_SERVER,szVideoFileName);
	if(dwAddrLen>0)
	{
		CT2CA strServerDomain(szServerAddr);
		m_dwAVServerAddr=inet_addr(strServerDomain);
	}
	else
	{
		m_dwAVServerAddr=0;
	}

	return true;
}

//停止事件
bool CAttemperEngineSink::OnAttemperEngineConclude(IUnknownEx * pIUnknownEx)
{
	//状态变量
	m_bNeekCorrespond=true;

	//组件变量
	m_pITimerEngine=NULL;
	m_pIDataBaseEngine=NULL;
	m_pITCPNetworkEngine=NULL;
	m_pITCPSocketService=NULL;

	//删除数据
	SafeDeleteArray(m_pBindParameter);

	//列表组件
	m_ServerListManager.ResetServerList();

	return true;
}

//控制事件
bool CAttemperEngineSink::OnEventControl(WORD wIdentifier, VOID * pData, WORD wDataSize)
{
	switch (wIdentifier)
	{
	case CT_LOAD_DB_GAME_LIST:		//加载列表
		{
			//加载列表
			m_ServerListManager.DisuseKernelItem();
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_LOAD_GAME_LIST,0,NULL,0);

			return true;
		}
	case CT_CONNECT_CORRESPOND:		//连接协调
		{
			//发起连接
			tagAddressInfo * pCorrespondAddress=&m_pInitParameter->m_CorrespondAddress;
			m_pITCPSocketService->Connect(pCorrespondAddress->szAddress,m_pInitParameter->m_wCorrespondPort);

			//构造提示
			TCHAR szString[512]=TEXT("");
			_sntprintf(szString,CountArray(szString),TEXT("正在连接协调服务器 [ %s:%d ]"),pCorrespondAddress->szAddress,m_pInitParameter->m_wCorrespondPort);

			//提示消息
			CTraceService::TraceString(szString,TraceLevel_Normal);

			return true;
		}
	}

	return false;
}

//调度事件
bool CAttemperEngineSink::OnEventAttemperData(WORD wRequestID, VOID * pData, WORD wDataSize)
{
	return false;
}

//时间事件
bool CAttemperEngineSink::OnEventTimer(DWORD dwTimerID, WPARAM wBindParam)
{
	switch (dwTimerID)
	{
	case IDI_LOAD_GAME_LIST:		//加载列表
		{
			//加载列表
			m_ServerListManager.DisuseKernelItem();
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_LOAD_GAME_LIST,0,NULL,0);

			return true;
		}
	case IDI_CONNECT_CORRESPOND:	//连接协调
		{
			//发起连接
			tagAddressInfo * pCorrespondAddress=&m_pInitParameter->m_CorrespondAddress;
			m_pITCPSocketService->Connect(pCorrespondAddress->szAddress,m_pInitParameter->m_wCorrespondPort);

			//构造提示
			TCHAR szString[512]=TEXT("");
			_sntprintf(szString,CountArray(szString),TEXT("正在连接协调服务器 [ %s:%d ]"),pCorrespondAddress->szAddress,m_pInitParameter->m_wCorrespondPort);

			//提示消息
			CTraceService::TraceString(szString,TraceLevel_Normal);

			return true;
		}
	case IDI_COLLECT_ONLINE_INFO:	//统计在线
		{
			//变量定义
			DBR_GP_OnLineCountInfo OnLineCountInfo;
			ZeroMemory(&OnLineCountInfo,sizeof(OnLineCountInfo));

			//获取总数
			OnLineCountInfo.dwOnLineCountSum=m_ServerListManager.CollectOnlineInfo();

			//获取类型
			POSITION KindPosition=NULL;
			do
			{
				//获取类型
				CGameKindItem * pGameKindItem=m_ServerListManager.EmunGameKindItem(KindPosition);

				//设置变量
				if (pGameKindItem!=NULL)
				{
					WORD wKindIndex=OnLineCountInfo.wKindCount++;
					OnLineCountInfo.OnLineCountKind[wKindIndex].wKindID=pGameKindItem->m_GameKind.wKindID;
					OnLineCountInfo.OnLineCountKind[wKindIndex].dwOnLineCount=pGameKindItem->m_GameKind.dwOnLineCount;
				}

				//溢出判断
				if (OnLineCountInfo.wKindCount>=CountArray(OnLineCountInfo.OnLineCountKind))
				{
					ASSERT(FALSE);
					break;
				}

			} while (KindPosition!=NULL);

			//发送请求
			WORD wHeadSize=sizeof(OnLineCountInfo)-sizeof(OnLineCountInfo.OnLineCountKind);
			WORD wSendSize=wHeadSize+OnLineCountInfo.wKindCount*sizeof(OnLineCountInfo.OnLineCountKind[0]);
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_ONLINE_COUNT_INFO,0,&OnLineCountInfo,wSendSize);

			return true;
		}
	}

	return false;
}

//应答事件
bool CAttemperEngineSink::OnEventTCPNetworkBind(DWORD dwClientAddr, DWORD dwSocketID)
{
	//获取索引
	ASSERT(LOWORD(dwSocketID)<m_pInitParameter->m_wMaxConnect);
	if (LOWORD(dwSocketID)>=m_pInitParameter->m_wMaxConnect) return false;

//	CString str;
//	str.Format(TEXT("%ld"), dwClientAddr);

//	CTraceService::TraceString(str,TraceLevel_Normal);

	//变量定义
	WORD wBindIndex=LOWORD(dwSocketID);
	tagBindParameter * pBindParameter=(m_pBindParameter+wBindIndex);

	//设置变量
	pBindParameter->dwSocketID=dwSocketID;
	pBindParameter->dwClientAddr=dwClientAddr;
	pBindParameter->dwActiveTime=(DWORD)time(NULL);

	return true;
}

//关闭事件
bool CAttemperEngineSink::OnEventTCPNetworkShut(DWORD dwClientAddr, DWORD dwActiveTime, DWORD dwSocketID)
{
	//清除信息
	WORD wBindIndex=LOWORD(dwSocketID);
	ZeroMemory((m_pBindParameter+wBindIndex),sizeof(tagBindParameter));

	// 记录离开信息
	return false;
}

//读取事件
bool CAttemperEngineSink::OnEventTCPNetworkRead(TCP_Command Command, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	LOGI("CAttemperEngineSink::OnEventTCPNetworkRead, wMainCmdID=" << Command.wMainCmdID << ", wSubCmdID="<< Command.wSubCmdID);
	switch (Command.wMainCmdID)
	{
	case MDM_GP_LOGON:			//登录命令
		{
			return OnTCPNetworkMainPCLogon(Command.wSubCmdID,pData,wDataSize,dwSocketID);
		}
	case MDM_GP_SERVER_LIST:	//列表命令
		{
			return OnTCPNetworkMainPCServerList(Command.wSubCmdID,pData,wDataSize,dwSocketID);
		}
	case MDM_GP_USER_SERVICE:	//服务命令
		{
			return OnTCPNetworkMainPCUserService(Command.wSubCmdID,pData,wDataSize,dwSocketID);
		}
	case MDM_GP_REMOTE_SERVICE:	//远程服务
		{
			return OnTCPNetworkMainPCRemoteService(Command.wSubCmdID,pData,wDataSize,dwSocketID);
		}
	case MDM_MB_LOGON:			//MB登录命令
		{
			return OnTCPNetworkMainMBLogon(Command.wSubCmdID,pData,wDataSize,dwSocketID);
		}
	case MDM_MB_SERVER_LIST:	//列表命令
		{
			return OnTCPNetworkMainMBServerList(Command.wSubCmdID,pData,wDataSize,dwSocketID);
		}
	case MDM_MB_SYSTEM_MESSAGE:	// 请求系统配置消息
		{
			return OnTCPNetworkMainMBSystemMessage(Command.wSubCmdID,pData,wDataSize,dwSocketID);
		}
	}
	return false;
}

//数据库事件
bool CAttemperEngineSink::OnEventDataBase(WORD wRequestID, DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	switch (wRequestID)
	{
	case DBO_GP_LOGON_SUCCESS:			//登录成功
		{
			return OnDBPCLogonSuccess(dwContextID,pData,wDataSize);
		}
	case DBO_GP_LOGON_FAILURE:			//登录失败
		{
			return OnDBPCLogonFailure(dwContextID,pData,wDataSize);
		}
	case DBR_GP_VALIDATE_MBCARD:
		{
			return OnDBPCLogonValidateMBCard(dwContextID,pData,wDataSize);
		}
	case DBO_GP_PROFILE_SUCCESS:
		{
			return OnDBPCProfileSuccess(dwContextID,pData,wDataSize);
		}
	case DBO_GP_PROFILE_FAILURE:
		{
			return OnDBPCProfileFailure(dwContextID,pData,wDataSize);
		}
	case DBO_GP_CHECKNICK:
		{
			return OnDBPCCheckNick(dwContextID,pData,wDataSize);
		}
	case DBO_GP_USER_FACE_INFO:			//用户头像
		{
			return OnDBPCUserFaceInfo(dwContextID,pData,wDataSize);
		}
	case DBO_GP_USER_INDIVIDUAL:		//用户信息
		{
			return OnDBPCUserIndividual(dwContextID,pData,wDataSize);
		}
	case DBO_GP_USER_INSURE_INFO:		//银行资料
		{
			return OnDBPCUserInsureInfo(dwContextID,pData,wDataSize);
		}
    case DBR_GP_TRANS_RECORD:
        {
            return OnDBPCUserTransRecord(dwContextID,pData,wDataSize);
        }
	case DBO_GP_USER_INSURE_SUCCESS:	//银行成功
		{
			return OnDBPCUserInsureSuccess(dwContextID,pData,wDataSize);
		}
	case DBO_GP_USER_INSURE_FAILURE:	//银行失败
		{
			return OnDBPCUserInsureFailure(dwContextID,pData,wDataSize);
		}
	case DBO_GP_USER_INSURE_USER_INFO:  //用户信息
		{
			return OnDBPCUserInsureUserInfo(dwContextID,pData,wDataSize);
		}
	case DBO_GP_OPERATE_SUCCESS:		//操作成功
		{
			return OnDBPCOperateSuccess(dwContextID,pData,wDataSize);
		}
	case DBO_GP_OPERATE_FAILURE:		//操作失败
		{
			return OnDBPCOperateFailure(dwContextID,pData,wDataSize);
		}
	case DBO_GP_GAME_TYPE_ITEM:			//类型子项
		{
			return OnDBPCGameTypeItem(dwContextID,pData,wDataSize);
		}
	case DBO_GP_GAME_KIND_ITEM:			//类型子项
		{
			return OnDBPCGameKindItem(dwContextID,pData,wDataSize);
		}
	case DBO_GP_GAME_NODE_ITEM:			//节点子项
		{
			return OnDBPCGameNodeItem(dwContextID,pData,wDataSize);
		}
	case DBO_GP_GAME_PAGE_ITEM:			//定制子项
		{
			return OnDBPCGamePageItem(dwContextID,pData,wDataSize);
		}
	case DBO_MB_AREA_GAME_KIND_ITEM:	//区域ID相关的GameKindItem
		{
			return OnDBMBAreaGameKindItem(dwContextID, pData, wDataSize);
		}
	case DBO_MB_AREA_GAME_SERVER_ITEM:	//区域ID相关的GameServerItem
		{
			return OnDBMBAreaGameServerItem(dwContextID, pData, wDataSize);
		}
	case DBO_MB_GAME_KIND_ITEM_EX:		// GameKind扩展信息,用于App
		{
			return OnDBMBGameKindItemEx(dwContextID, pData, wDataSize);
		}
	case DBO_MB_CUSTOMTABLE_PROPERTYCONFIG:	// 自建桌子,消耗道具和局数配置
		{
			return OnDBMBCustomTablePropertyConfig(dwContextID, pData, wDataSize);
		}
	case DBO_GP_GAME_LIST_RESULT:		//加载结果
		{
			return OnDBPCGameListResult(dwContextID,pData,wDataSize);
		}
	case DBO_MB_LOGON_SUCCESS:			//登录成功
		{
			return OnDBMBLogonSuccess(dwContextID,pData,wDataSize);
		}
	case DBO_MB_LOGON_FAILURE:			//登录失败
		{
			return OnDBMBLogonFailure(dwContextID,pData,wDataSize);
		}
	case DBO_GP_INSURE_TRANS_RECEIPT:	// 转账成功回执
		{
			return OnDBPCUserTransReceipt(dwContextID,pData,wDataSize);
		}
	case DBO_GP_QUERY_EXCHANGE_LOVELINESS_INFO:	// 魅力兑换配置读取成功
		{
			return OnDBPExchangeLovelinessInfo(dwContextID, pData, wDataSize);
		}
	case DBO_GP_EXCHANGE_LOVELINESS:	// 魅力兑换
		{
			return 	OnDBPExchangeLoveliness(dwContextID, pData, wDataSize);
		}
	case DBO_MB_SIGN_IN_CHECK_SUCCESS:
		{
			// 签到成功
			return OnDBMBSignInCheckSuccess(dwContextID, pData, wDataSize);
		}
	case DBO_MB_RECHARGE_MESSAGE:
		{
			// 充值系统消息
			return OnDBMBRechargeMessage(dwContextID, pData, wDataSize);
		}
		break;
	case DBO_MB_CUSTOM_SERVICE_MESSAGE:
		{
			// 客服消息
			return OnDBMBCustomServiceMessage(dwContextID, pData, wDataSize);
		}
		break;
	case DBO_GR_USER_CUSTOMTABLE_SUCCESS:
		{
			return OnDBUserCustomTableSuccess(dwContextID, pData, wDataSize);
		}
		break;
	case DBO_GR_USER_CUSTOMTABLE_FAILURE:
		{
			return OnDBUserCustomTableFailed(dwContextID, pData, wDataSize);
		}
		break;
	case DBO_MB_USER_DIAMOND_SUCCESS:		// 钻石操作成功
		{
			return OnDBUserDiamondSuccess(dwContextID, pData, wDataSize);
		}
		break;
	case DBO_MB_USER_DIAMOND_FAILURE:		// 钻石操作失败
		{
			return OnDBUserDiamondFialed(dwContextID, pData, wDataSize);
		}
		break;
	}

	return false;
}

//关闭事件
bool CAttemperEngineSink::OnEventTCPSocketShut(WORD wServiceID, BYTE cbShutReason)
{
	try
	{
		//协调连接
		if (wServiceID==NETWORK_CORRESPOND)
		{
			//重连判断
			if (m_bNeekCorrespond==true)
			{
				//构造提示
				TCHAR szDescribe[128]=TEXT("");
				_sntprintf(szDescribe,CountArray(szDescribe),TEXT("与协调服务器的连接关闭了，%ld 秒后将重新连接"),m_pInitParameter->m_wConnectTime);

				//提示消息
				CTraceService::TraceString(szDescribe,TraceLevel_Warning);

				//设置时间
				ASSERT(m_pITimerEngine!=NULL);
				m_pITimerEngine->SetTimer(IDI_CONNECT_CORRESPOND,m_pInitParameter->m_wConnectTime*1000L,1,0);

				return true;
			}
		}
	}
	catch(...)
	{
		LOGE("CAttemperEngineSink::OnEventTCPSocketShut catch");
	}

	return false;
}

//连接事件
bool CAttemperEngineSink::OnEventTCPSocketLink(WORD wServiceID, INT nErrorCode)
{
	//协调连接
	if (wServiceID==NETWORK_CORRESPOND)
	{
		//错误判断
		if (nErrorCode!=0)
		{
			//构造提示
			TCHAR szDescribe[128]=TEXT("");
			_sntprintf(szDescribe,CountArray(szDescribe),TEXT("协调服务器连接失败 [ %ld ]，%ld 秒后将重新连接"),
				nErrorCode,m_pInitParameter->m_wConnectTime);

			//提示消息
			CTraceService::TraceString(szDescribe,TraceLevel_Warning);

			//设置时间
			ASSERT(m_pITimerEngine!=NULL);
			m_pITimerEngine->SetTimer(IDI_CONNECT_CORRESPOND,m_pInitParameter->m_wConnectTime*1000L,1,0);

			return false;
		}

		//提示消息
		CTraceService::TraceString(TEXT("正在注册游戏登录服务器..."),TraceLevel_Normal);

		//变量定义
		CMD_CS_C_RegisterPlaza RegisterPlaza;
		ZeroMemory(&RegisterPlaza,sizeof(RegisterPlaza));

		//设置变量
		lstrcpyn(RegisterPlaza.szServerName,m_pInitParameter->m_szServerName,CountArray(RegisterPlaza.szServerName));
		lstrcpyn(RegisterPlaza.szServerAddr,m_pInitParameter->m_ServiceAddress.szAddress,CountArray(RegisterPlaza.szServerAddr));

		//发送数据
		m_pITCPSocketService->SendData(MDM_CS_REGISTER,SUB_CS_C_REGISTER_PLAZA,&RegisterPlaza,sizeof(RegisterPlaza));

		return true;
	}

	return true;
}

//读取事件
bool CAttemperEngineSink::OnEventTCPSocketRead(WORD wServiceID, TCP_Command Command, VOID * pData, WORD wDataSize)
{
	//协调连接
	if (wServiceID==NETWORK_CORRESPOND)
	{
		switch (Command.wMainCmdID)
		{
		case MDM_CS_REGISTER:		//注册服务
			{
				return OnTCPSocketMainRegister(Command.wSubCmdID,pData,wDataSize);
			}
		case MDM_CS_SERVICE_INFO:	//服务信息
			{
				return OnTCPSocketMainServiceInfo(Command.wSubCmdID,pData,wDataSize);
			}
		case MDM_CS_REMOTE_SERVICE:	//远程服务
			{
				return OnTCPSocketMainRemoteService(Command.wSubCmdID,pData,wDataSize);
			}
		case MDM_CS_MANAGER_SERVICE: //管理服务
			{
				return true;
			}
		}
	}

	//错误断言
	ASSERT(FALSE);

	return true;
}

//注册事件
bool CAttemperEngineSink::OnTCPSocketMainRegister(WORD wSubCmdID, VOID * pData, WORD wDataSize)
{
	switch (wSubCmdID)
	{
	case SUB_CS_S_REGISTER_FAILURE:		//注册失败
		{
			//变量定义
			CMD_CS_S_RegisterFailure * pRegisterFailure=(CMD_CS_S_RegisterFailure *)pData;

			//效验参数
			ASSERT(wDataSize>=(sizeof(CMD_CS_S_RegisterFailure)-sizeof(pRegisterFailure->szDescribeString)));
			if (wDataSize<(sizeof(CMD_CS_S_RegisterFailure)-sizeof(pRegisterFailure->szDescribeString))) return false;

			//关闭处理
			m_bNeekCorrespond=false;
			m_pITCPSocketService->CloseSocket();

			//显示消息
			LPCTSTR pszDescribeString=pRegisterFailure->szDescribeString;
			if (lstrlen(pszDescribeString)>0) CTraceService::TraceString(pszDescribeString,TraceLevel_Exception);

			//事件通知
			CP_ControlResult ControlResult;
			ControlResult.cbSuccess=ER_FAILURE;
			SendUIControlPacket(UI_CORRESPOND_RESULT,&ControlResult,sizeof(ControlResult));

			return true;
		}
	}

	return true;
}

//列表事件
bool CAttemperEngineSink::OnTCPSocketMainServiceInfo(WORD wSubCmdID, VOID * pData, WORD wDataSize)
{
	switch (wSubCmdID)
	{
	case SUB_CS_S_SERVER_INFO:		//房间信息
		{
			//废弃列表
			m_ServerListManager.DisuseServerItem();

			return true;
		}
	case SUB_CS_S_SERVER_ONLINE:	//房间人数
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_CS_S_ServerOnLine));
			if (wDataSize!=sizeof(CMD_CS_S_ServerOnLine)) return false;

			//变量定义
			CMD_CS_S_ServerOnLine * pServerOnLine=(CMD_CS_S_ServerOnLine *)pData;

			//查找房间
			CGameServerItem * pGameServerItem=m_ServerListManager.SearchGameServer(pServerOnLine->wServerID);
			if(pGameServerItem == NULL) return true;

			//设置人数
			DWORD dwOldOnlineCount=0;
			dwOldOnlineCount = pGameServerItem->m_GameServer.dwOnLineCount;
			pGameServerItem->m_GameServer.dwOnLineCount=pServerOnLine->dwOnLineCount;

			//目录人数
			CGameKindItem * pGameKindItem=m_ServerListManager.SearchGameKind(pGameServerItem->m_GameServer.wKindID);
			if (pGameKindItem!=NULL)
			{
				tagGameServer * pGameServer=&pGameServerItem->m_GameServer;
				pGameKindItem->m_GameKind.dwOnLineCount -= dwOldOnlineCount;
				pGameKindItem->m_GameKind.dwOnLineCount += pGameServer->dwOnLineCount;
			}

			return true;
		}
	case SUB_CS_S_SERVER_INSERT:	//房间插入
		{
			//效验参数
			
			ASSERT(wDataSize%sizeof(tagGameServer)==0);
			if (wDataSize%sizeof(tagGameServer)!=0) return false;

			//变量定义
			WORD wItemCount=wDataSize/sizeof(tagGameServer);
			tagGameServer * pGameServer=(tagGameServer *)pData;

			//更新数据
			for (WORD i=0;i<wItemCount;i++)
			{
				m_ServerListManager.InsertGameServer(pGameServer++);
			}

			return true;
		}
	case SUB_CS_S_SERVER_MODIFY:	//房间修改
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_CS_S_ServerModify));
			if (wDataSize!=sizeof(CMD_CS_S_ServerModify)) return false;

			//变量定义
			CMD_CS_S_ServerModify * pServerModify=(CMD_CS_S_ServerModify *)pData;

			//查找房间
			ASSERT(m_ServerListManager.SearchGameServer(pServerModify->wServerID));
			CGameServerItem * pGameServerItem=m_ServerListManager.SearchGameServer(pServerModify->wServerID);

			//设置房间
			if (pGameServerItem!=NULL)
			{
				//设置人数
				DWORD dwOldOnlineCount=0, dwOldFullCount=0;
				dwOldOnlineCount = pGameServerItem->m_GameServer.dwOnLineCount;
				dwOldFullCount   = pGameServerItem->m_GameServer.dwFullCount;

				//修改房间信息
				pGameServerItem->m_GameServer.wKindID=pServerModify->wKindID;
				pGameServerItem->m_GameServer.wNodeID=pServerModify->wNodeID;
				pGameServerItem->m_GameServer.wSortID=pServerModify->wSortID;
				pGameServerItem->m_GameServer.wServerPort=pServerModify->wServerPort;
				pGameServerItem->m_GameServer.dwOnLineCount=pServerModify->dwOnLineCount;
				pGameServerItem->m_GameServer.dwFullCount=pServerModify->dwFullCount;
				lstrcpyn(pGameServerItem->m_GameServer.szServerName,pServerModify->szServerName,CountArray(pGameServerItem->m_GameServer.szServerName));
				lstrcpyn(pGameServerItem->m_GameServer.szServerAddr,pServerModify->szServerAddr,CountArray(pGameServerItem->m_GameServer.szServerAddr));

				//目录人数
				CGameKindItem * pGameKindItem=m_ServerListManager.SearchGameKind(pGameServerItem->m_GameServer.wKindID);
				if (pGameKindItem!=NULL)
				{
					tagGameServer * pGameServer=&pGameServerItem->m_GameServer;
					pGameKindItem->m_GameKind.dwOnLineCount -= dwOldOnlineCount;
					pGameKindItem->m_GameKind.dwOnLineCount += pGameServer->dwOnLineCount;

					pGameKindItem->m_GameKind.dwFullCount -= dwOldFullCount;
					pGameKindItem->m_GameKind.dwFullCount += pGameServer->dwFullCount;
				}
			}

			return true;
		}
	case SUB_CS_S_SERVER_REMOVE:	//房间删除
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_CS_S_ServerRemove));
			if (wDataSize!=sizeof(CMD_CS_S_ServerRemove)) return false;

			//变量定义
			CMD_CS_S_ServerRemove * pServerRemove=(CMD_CS_S_ServerRemove *)pData;

			//变量定义
			m_ServerListManager.DeleteGameServer(pServerRemove->wServerID);

			return true;
		}
	case SUB_CS_S_SERVER_FINISH:	//房间完成
		{
			//清理列表
			m_ServerListManager.CleanServerItem();

			//事件处理
			CP_ControlResult ControlResult;
			ControlResult.cbSuccess=ER_SUCCESS;
			SendUIControlPacket(UI_CORRESPOND_RESULT,&ControlResult,sizeof(ControlResult));

			return true;
		}
	}

	return true;
}

//远程服务
bool CAttemperEngineSink::OnTCPSocketMainRemoteService(WORD wSubCmdID, VOID * pData, WORD wDataSize)
{
	switch (wSubCmdID)
	{
	case SUB_CS_S_SEARCH_CORRESPOND:	//协调查找
		{
			//变量定义
			CMD_CS_S_SearchCorrespond * pSearchCorrespond=(CMD_CS_S_SearchCorrespond *)pData;

			//效验参数
			ASSERT(wDataSize<=sizeof(CMD_CS_S_SearchCorrespond));
			ASSERT(wDataSize>=(sizeof(CMD_CS_S_SearchCorrespond)-sizeof(pSearchCorrespond->UserRemoteInfo)));
			ASSERT(wDataSize==(sizeof(CMD_CS_S_SearchCorrespond)-sizeof(pSearchCorrespond->UserRemoteInfo)+pSearchCorrespond->wUserCount*sizeof(pSearchCorrespond->UserRemoteInfo[0])));

			//效验参数
			if (wDataSize>sizeof(CMD_CS_S_SearchCorrespond)) return false;
			if (wDataSize<(sizeof(CMD_CS_S_SearchCorrespond)-sizeof(pSearchCorrespond->UserRemoteInfo))) return false;
			if (wDataSize!=(sizeof(CMD_CS_S_SearchCorrespond)-sizeof(pSearchCorrespond->UserRemoteInfo)+pSearchCorrespond->wUserCount*sizeof(pSearchCorrespond->UserRemoteInfo[0]))) return false;

			//判断在线
			ASSERT(LOWORD(pSearchCorrespond->dwSocketID)<m_pInitParameter->m_wMaxConnect);
			if ((m_pBindParameter+LOWORD(pSearchCorrespond->dwSocketID))->dwSocketID!=pSearchCorrespond->dwSocketID) return true;

			//变量定义
			CMD_GP_S_SearchCorrespond SearchCorrespond;
			ZeroMemory(&SearchCorrespond,sizeof(SearchCorrespond));

			//设置变量
			for (WORD i=0;i<pSearchCorrespond->wUserCount;i++)
			{
				//数据效验
				ASSERT(SearchCorrespond.wUserCount<CountArray(SearchCorrespond.UserRemoteInfo));
				if (SearchCorrespond.wUserCount>=CountArray(SearchCorrespond.UserRemoteInfo)) break;

				//设置变量
				WORD wIndex=SearchCorrespond.wUserCount++;
				CopyMemory(&SearchCorrespond.UserRemoteInfo[wIndex],&pSearchCorrespond->UserRemoteInfo[i],sizeof(SearchCorrespond.UserRemoteInfo[wIndex]));
			}

			//发送数据
			WORD wHeadSize=sizeof(SearchCorrespond)-sizeof(SearchCorrespond.UserRemoteInfo);
			WORD wItemSize=sizeof(SearchCorrespond.UserRemoteInfo[0])*SearchCorrespond.wUserCount;
			m_pITCPNetworkEngine->SendData(pSearchCorrespond->dwSocketID,MDM_GP_REMOTE_SERVICE,SUB_GP_S_SEARCH_CORRESPOND,&SearchCorrespond,wHeadSize+wItemSize);

			return true;
		}
		case SUB_CS_S_USER_CUSTOM_TABLE_SUCCESS:
		{
			// 自建桌子成功
			//效验参数
			ASSERT(wDataSize == sizeof(CMD_CS_C_UserCustomTableSuccess));
			if (wDataSize != sizeof(CMD_CS_C_UserCustomTableSuccess)) return false;

			//变量定义
			CMD_CS_C_UserCustomTableSuccess * pUserCustomTableSuccess = (CMD_CS_C_UserCustomTableSuccess *)pData;

			//用户自定义房间(协调服务器→登录服务器)
			CMD_MB_UserCustomTableSuccess UserCustomTableSuccess;
//			UserCustomTableSuccess.wKindID = pUserCustomTableSuccess->wKindID;
			UserCustomTableSuccess.wServerID = pUserCustomTableSuccess->wServerID;
			lstrcpyn(UserCustomTableSuccess.szSecret, pUserCustomTableSuccess->szSecret, CountArray(UserCustomTableSuccess.szSecret));
			UserCustomTableSuccess.bLockedInTable = true;
			UserCustomTableSuccess.dwDiamondCount = pUserCustomTableSuccess->dwPropertyCount;
			m_pITCPNetworkEngine->SendData(pUserCustomTableSuccess->dwSocketID, MDM_GP_USER_SERVICE, SUB_MB_USER_CUSTOM_TABLE_SUCCESS, &UserCustomTableSuccess, sizeof(UserCustomTableSuccess));

			return true;
		}
		case SUB_CS_S_USER_CUSTOM_TABLE_FAILED:
		{	
			//效验参数
			ASSERT(wDataSize == sizeof(CMD_CS_C_UserCustomTableFailed));
			if (wDataSize != sizeof(CMD_CS_C_UserCustomTableFailed)) return false;

			//变量定义
			CMD_CS_C_UserCustomTableFailed * pUserCustomTableFailed = (CMD_CS_C_UserCustomTableFailed *)pData;
			
			CMD_MB_UserCustomTableFailed UserCustomTableFailed;
			memset(&UserCustomTableFailed, 0, sizeof(UserCustomTableFailed));
			UserCustomTableFailed.lErrorCode = UserCustomTableFailed.lErrorCode;
//			UserCustomTableFailed.bLockedInTable = false;
			lstrcpyn(UserCustomTableFailed.szDescribeString, pUserCustomTableFailed->szDescribeString, CountArray(UserCustomTableFailed.szDescribeString));

			//发送数据
			WORD wStringSize = CountStringBuffer(UserCustomTableFailed.szDescribeString);
			WORD wSendSize = sizeof(UserCustomTableFailed) - sizeof(UserCustomTableFailed.szDescribeString) + wStringSize;
			//用户自定义房间(协调服务器→登录服务器)
			m_pITCPNetworkEngine->SendData(pUserCustomTableFailed->dwSocketID, MDM_GP_USER_SERVICE, SUB_MB_USER_CUSTOM_TABLE_FAILED, &UserCustomTableFailed, wSendSize);

			return true;
		}
	}

	return true;
}

//登录处理
bool CAttemperEngineSink::OnTCPNetworkMainPCLogon(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	switch (wSubCmdID)
	{
	case SUB_GP_LOGON_GAMEID:		//I D 登录
		{
			return OnTCPNetworkSubPCLogonGameID(pData,wDataSize,dwSocketID);
		}
	case SUB_GP_LOGON_ACCOUNTS:		//帐号登录
		{
//			LOGI("CAttemperEngineSink::OnTCPNetworkMainPCLogon, OnTCPNetworkSubPCLogonAccounts");
			return OnTCPNetworkSubPCLogonAccounts(pData,wDataSize,dwSocketID);
		}
	case SUB_GP_REGISTER_ACCOUNTS:	//帐号注册
		{
			return OnTCPNetworkSubPCRegisterAccounts(pData,wDataSize,dwSocketID);
		}
	case SUB_GP_REGISTER_PROFILE:	//补充资料 by chenj
		{
			//效验参数
			ASSERT(wDataSize>=sizeof(CMD_GP_UserProfile));
			if (wDataSize<sizeof(CMD_GP_UserProfile)) return false;

			//处理消息
			CMD_GP_UserProfile * pRegisterProfile=(CMD_GP_UserProfile *)pData;
			pRegisterProfile->szPassword[CountArray(pRegisterProfile->szPassword)-1]=0;

			//变量定义
			DBR_GP_RegisterProfile RegisterProfile;
			ZeroMemory(&RegisterProfile,sizeof(RegisterProfile));

			RegisterProfile.dwUserID = pRegisterProfile->dwUserID;
			RegisterProfile.dwClientAddr = (m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
			RegisterProfile.cbGender = pRegisterProfile->cbGender;
			lstrcpyn(RegisterProfile.szPassword,pRegisterProfile->szPassword,CountArray(RegisterProfile.szPassword));
			lstrcpyn(RegisterProfile.szNickName,pRegisterProfile->szNickName,CountArray(RegisterProfile.szNickName));
			lstrcpyn(RegisterProfile.szQQ,pRegisterProfile->szQQ,CountArray(RegisterProfile.szQQ));
			lstrcpyn(RegisterProfile.szMobile,pRegisterProfile->szMobile,CountArray(RegisterProfile.szMobile));
			lstrcpyn(RegisterProfile.szUnderWrite,pRegisterProfile->szUnderWrite,CountArray(RegisterProfile.szUnderWrite));
			lstrcpyn(RegisterProfile.szPassPortID,pRegisterProfile->szPassPortID,CountArray(RegisterProfile.szPassPortID));
			lstrcpyn(RegisterProfile.szCompellation,pRegisterProfile->szCompellation,CountArray(RegisterProfile.szCompellation));
			lstrcpyn(RegisterProfile.szSecurityQuestion,pRegisterProfile->szSecurityQuestion,CountArray(RegisterProfile.szSecurityQuestion));
			lstrcpyn(RegisterProfile.szSecurityAnswer,pRegisterProfile->szSecurityAnswer,CountArray(RegisterProfile.szSecurityAnswer));

			// 根据性别来产生头像
			CRandom random;
			do 
			{
				RegisterProfile.wFaceID = random.Random(8);
			} while ( (RegisterProfile.wFaceID/4)!=RegisterProfile.cbGender);

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_REGISTER_PROFILE,dwSocketID,&RegisterProfile,sizeof(RegisterProfile));

			return true;
		}
	case SUB_GP_CHECKNICK:
		{
			//效验参数
			ASSERT(wDataSize>=sizeof(CMD_GP_CheckNick));
			if (wDataSize<sizeof(CMD_GP_CheckNick)) return false;

			//处理消息
			CMD_GP_CheckNick * pCheckNick=(CMD_GP_CheckNick *)pData;

			//变量定义
			DBR_GP_CheckNick CheckNick;
			ZeroMemory(&CheckNick,sizeof(CheckNick));

			CheckNick.dwUserID = pCheckNick->dwUserID;
			lstrcpyn(CheckNick.szNickName,pCheckNick->szNickName,CountArray(CheckNick.szNickName));

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_CHECKNICK,dwSocketID,&CheckNick,sizeof(CheckNick));
			return true;
		}
	}

	return false;
}

//列表处理
bool CAttemperEngineSink::OnTCPNetworkMainPCServerList(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	switch (wSubCmdID)
	{
	case SUB_GP_GET_LIST:			//获取列表
		{
			//发送列表
			SendGameTypeInfo(dwSocketID);
			SendGameKindInfo(dwSocketID);

			//发送列表
			if (m_pInitParameter->m_cbDelayList==TRUE)
			{
				//发送列表
				SendGamePageInfo(dwSocketID,INVALID_WORD);
				SendGameNodeInfo(dwSocketID,INVALID_WORD);
				SendGameServerInfo(dwSocketID,INVALID_WORD);
			}
			else
			{
				//发送页面
				SendGamePageInfo(dwSocketID,0);
			}

			//发送完成
			m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_FINISH);

			return true;
		}
	case SUB_GP_GET_SERVER:			//获取房间
		{
			//效验数据
			ASSERT(wDataSize%sizeof(WORD)==0);
			if (wDataSize%sizeof(WORD)!=0) return false;

			//发送列表
			UINT nKindCount=wDataSize/sizeof(WORD);
			for (UINT i=0;i<nKindCount;i++)
			{
				SendGameNodeInfo(dwSocketID,((WORD *)pData)[i]);
				SendGamePageInfo(dwSocketID,((WORD *)pData)[i]);
				SendGameServerInfo(dwSocketID,((WORD *)pData)[i]);
			}

			//发送完成
			m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_SERVER_FINISH,pData,wDataSize);

			return true;
		}
	case SUB_GP_GET_ONLINE:			//获取在线
		{
			//变量定义
			CMD_GP_GetOnline * pGetOnline=(CMD_GP_GetOnline *)pData;
			WORD wHeadSize=(sizeof(CMD_GP_GetOnline)-sizeof(pGetOnline->wOnLineServerID));

			//效验数据
			ASSERT((wDataSize>=wHeadSize)&&(wDataSize==(wHeadSize+pGetOnline->wServerCount*sizeof(WORD))));
			if ((wDataSize<wHeadSize)||(wDataSize!=(wHeadSize+pGetOnline->wServerCount*sizeof(WORD)))) return false;

			//变量定义
			CMD_GP_KindOnline KindOnline;
			CMD_GP_ServerOnline ServerOnline;
			ZeroMemory(&KindOnline,sizeof(KindOnline));
			ZeroMemory(&ServerOnline,sizeof(ServerOnline));

			//获取类型
			POSITION KindPosition=NULL;
			do
			{
				//获取类型
				CGameKindItem * pGameKindItem=m_ServerListManager.EmunGameKindItem(KindPosition);

				//设置变量
				if (pGameKindItem!=NULL)
				{
					WORD wKindIndex=KindOnline.wKindCount++;
					KindOnline.OnLineInfoKind[wKindIndex].wKindID=pGameKindItem->m_GameKind.wKindID;
					KindOnline.OnLineInfoKind[wKindIndex].dwOnLineCount=pGameKindItem->m_GameKind.dwOnLineCount;
				}

				//溢出判断
				if (KindOnline.wKindCount>=CountArray(KindOnline.OnLineInfoKind))
				{
					ASSERT(FALSE);
					break;
				}

			} while (KindPosition!=NULL);

			//获取房间
			for (WORD i=0;i<pGetOnline->wServerCount;i++)
			{
				//获取房间
				WORD wServerID=pGetOnline->wOnLineServerID[i];
				CGameServerItem * pGameServerItem=m_ServerListManager.SearchGameServer(wServerID);

				//设置变量
				if (pGameServerItem!=NULL)
				{
					WORD wServerIndex=ServerOnline.wServerCount++;
					ServerOnline.OnLineInfoServer[wServerIndex].wServerID=wServerID;
					ServerOnline.OnLineInfoServer[wServerIndex].dwOnLineCount=pGameServerItem->m_GameServer.dwOnLineCount;
				}

				//溢出判断
				if (ServerOnline.wServerCount>=CountArray(ServerOnline.OnLineInfoServer))
				{
					ASSERT(FALSE);
					break;
				}
			}

			//类型在线
			if (KindOnline.wKindCount>0)
			{
				WORD wHeadSize=sizeof(KindOnline)-sizeof(KindOnline.OnLineInfoKind);
				WORD wSendSize=wHeadSize+KindOnline.wKindCount*sizeof(KindOnline.OnLineInfoKind[0]);
				m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GR_KINE_ONLINE,&KindOnline,wSendSize);
			}

			//房间在线
			if (ServerOnline.wServerCount>0)
			{
				WORD wHeadSize=sizeof(ServerOnline)-sizeof(ServerOnline.OnLineInfoServer);
				WORD wSendSize=wHeadSize+ServerOnline.wServerCount*sizeof(ServerOnline.OnLineInfoServer[0]);
				m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GR_SERVER_ONLINE,&ServerOnline,wSendSize);
			}

			return true;
		}
	case SUB_GP_GET_COLLECTION:		//获取收藏
		{
			return true;
		}
	}

	return false;
}

//服务处理
bool CAttemperEngineSink::OnTCPNetworkMainPCUserService(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	switch (wSubCmdID)
	{
	case SUB_GP_MODIFY_MACHINE:		//绑定机器
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_GP_ModifyMachine));
			if (wDataSize!=sizeof(CMD_GP_ModifyMachine)) return false;

			//处理消息
			CMD_GP_ModifyMachine * pModifyMachine=(CMD_GP_ModifyMachine *)pData;
			pModifyMachine->szPassword[CountArray(pModifyMachine->szPassword)-1]=0;

			//变量定义
			DBR_GP_ModifyMachine ModifyMachine;
			ZeroMemory(&ModifyMachine,sizeof(ModifyMachine));

			//构造数据
			ModifyMachine.cbBind=pModifyMachine->cbBind;
			ModifyMachine.dwUserID=pModifyMachine->dwUserID;
			ModifyMachine.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
			lstrcpyn(ModifyMachine.szPassword,pModifyMachine->szPassword,CountArray(ModifyMachine.szPassword));
			lstrcpyn(ModifyMachine.szMachineID,pModifyMachine->szMachineID,CountArray(ModifyMachine.szMachineID));

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_MODIFY_MACHINE,dwSocketID,&ModifyMachine,sizeof(ModifyMachine));

			return true;
		}
	case SUB_GP_MODIFY_LOGON_PASS:	//修改密码
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_GP_ModifyLogonPass));
			if (wDataSize!=sizeof(CMD_GP_ModifyLogonPass)) return false;

			//处理消息
			CMD_GP_ModifyLogonPass * pModifyLogonPass=(CMD_GP_ModifyLogonPass *)pData;
			pModifyLogonPass->szDesPassword[CountArray(pModifyLogonPass->szDesPassword)-1]=0;
			pModifyLogonPass->szScrPassword[CountArray(pModifyLogonPass->szScrPassword)-1]=0;

			//变量定义
			DBR_GP_ModifyLogonPass ModifyLogonPass;
			ZeroMemory(&ModifyLogonPass,sizeof(ModifyLogonPass));

			//构造数据
			ModifyLogonPass.dwUserID=pModifyLogonPass->dwUserID;
			ModifyLogonPass.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
			lstrcpyn(ModifyLogonPass.szDesPassword,pModifyLogonPass->szDesPassword,CountArray(ModifyLogonPass.szDesPassword));
			lstrcpyn(ModifyLogonPass.szScrPassword,pModifyLogonPass->szScrPassword,CountArray(ModifyLogonPass.szScrPassword));

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_MODIFY_LOGON_PASS,dwSocketID,&ModifyLogonPass,sizeof(ModifyLogonPass));

			return true;
		}
	case SUB_GP_MODIFY_INSURE_PASS:	//修改密码
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_GP_ModifyInsurePass));
			if (wDataSize!=sizeof(CMD_GP_ModifyInsurePass)) return false;

			//处理消息
			CMD_GP_ModifyInsurePass * pModifyInsurePass=(CMD_GP_ModifyInsurePass *)pData;
			pModifyInsurePass->szDesPassword[CountArray(pModifyInsurePass->szDesPassword)-1]=0;
			pModifyInsurePass->szScrPassword[CountArray(pModifyInsurePass->szScrPassword)-1]=0;

			//变量定义
			DBR_GP_ModifyInsurePass ModifyInsurePass;
			ZeroMemory(&ModifyInsurePass,sizeof(ModifyInsurePass));

			//构造数据
			ModifyInsurePass.dwUserID=pModifyInsurePass->dwUserID;
			ModifyInsurePass.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
			lstrcpyn(ModifyInsurePass.szDesPassword,pModifyInsurePass->szDesPassword,CountArray(ModifyInsurePass.szDesPassword));
			lstrcpyn(ModifyInsurePass.szScrPassword,pModifyInsurePass->szScrPassword,CountArray(ModifyInsurePass.szScrPassword));

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_MODIFY_INSURE_PASS,dwSocketID,&ModifyInsurePass,sizeof(ModifyInsurePass));

			return true;
		}
	case SUB_GP_MODIFY_UNDER_WRITE:	//修改签名
		{
			//变量定义
			CMD_GP_ModifyUnderWrite * pModifyUnderWrite=(CMD_GP_ModifyUnderWrite *)pData;

			//效验参数
			ASSERT(wDataSize<=sizeof(CMD_GP_ModifyUnderWrite));
			ASSERT(wDataSize>=(sizeof(CMD_GP_ModifyUnderWrite)-sizeof(pModifyUnderWrite->szUnderWrite)));
			ASSERT(wDataSize==(sizeof(CMD_GP_ModifyUnderWrite)-sizeof(pModifyUnderWrite->szUnderWrite)+CountStringBuffer(pModifyUnderWrite->szUnderWrite)));

			//效验参数
			if (wDataSize>sizeof(CMD_GP_ModifyUnderWrite)) return false;
			if (wDataSize<(sizeof(CMD_GP_ModifyUnderWrite)-sizeof(pModifyUnderWrite->szUnderWrite))) return false;
			if (wDataSize!=(sizeof(CMD_GP_ModifyUnderWrite)-sizeof(pModifyUnderWrite->szUnderWrite)+CountStringBuffer(pModifyUnderWrite->szUnderWrite))) return false;

			//处理消息
//			pModifyUnderWrite->szPassword[CountArray(pModifyUnderWrite->szPassword)-1]=0;
			pModifyUnderWrite->szUnderWrite[CountArray(pModifyUnderWrite->szUnderWrite)-1]=0;

			//变量定义
			DBR_GP_ModifyUnderWrite ModifyUnderWrite;
			ZeroMemory(&ModifyUnderWrite,sizeof(ModifyUnderWrite));

			//构造数据
			ModifyUnderWrite.dwUserID=pModifyUnderWrite->dwUserID;
			ModifyUnderWrite.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
//			lstrcpyn(ModifyUnderWrite.szPassword,pModifyUnderWrite->szPassword,CountArray(ModifyUnderWrite.szPassword));
			lstrcpyn(ModifyUnderWrite.szUnderWrite,pModifyUnderWrite->szUnderWrite,CountArray(ModifyUnderWrite.szUnderWrite));

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_MODIFY_UNDER_WRITE,dwSocketID,&ModifyUnderWrite,sizeof(ModifyUnderWrite));

			return true;
		}
	case SUB_GP_SYSTEM_FACE_INFO:	//修改头像
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_GP_SystemFaceInfo));
			if (wDataSize!=sizeof(CMD_GP_SystemFaceInfo)) return false;

			//处理消息
			CMD_GP_SystemFaceInfo * pSystemFaceInfo=(CMD_GP_SystemFaceInfo *)pData;

			//变量定义
			DBR_GP_ModifySystemFace ModifySystemFace;
			ZeroMemory(&ModifySystemFace,sizeof(ModifySystemFace));

			//构造数据
			ModifySystemFace.wFaceID=pSystemFaceInfo->wFaceID;
			ModifySystemFace.dwUserID=pSystemFaceInfo->dwUserID;
			ModifySystemFace.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
			lstrcpyn(ModifySystemFace.szPassword,pSystemFaceInfo->szPassword,CountArray(ModifySystemFace.szPassword));
			lstrcpyn(ModifySystemFace.szMachineID,pSystemFaceInfo->szMachineID,CountArray(ModifySystemFace.szMachineID));

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_MODIFY_SYSTEM_FACE,dwSocketID,&ModifySystemFace,sizeof(ModifySystemFace));

			return true;
		}
	case SUB_GP_CUSTOM_FACE_INFO:	//修改头像
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_GP_CustomFaceInfo));
			if (wDataSize!=sizeof(CMD_GP_CustomFaceInfo)) return false;

			//处理消息
			CMD_GP_CustomFaceInfo * pCustomFaceInfo=(CMD_GP_CustomFaceInfo *)pData;

			//变量定义
			DBR_GP_ModifyCustomFace ModifyCustomFace;
			ZeroMemory(&ModifyCustomFace,sizeof(ModifyCustomFace));

			//构造数据
			ModifyCustomFace.dwUserID=pCustomFaceInfo->dwUserID;
			ModifyCustomFace.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
			lstrcpyn(ModifyCustomFace.szPassword,pCustomFaceInfo->szPassword,CountArray(ModifyCustomFace.szPassword));
			lstrcpyn(ModifyCustomFace.szMachineID,pCustomFaceInfo->szMachineID,CountArray(ModifyCustomFace.szMachineID));
			CopyMemory(ModifyCustomFace.dwCustomFace,pCustomFaceInfo->dwCustomFace,sizeof(ModifyCustomFace.dwCustomFace));

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_MODIFY_CUSTOM_FACE,dwSocketID,&ModifyCustomFace,sizeof(ModifyCustomFace));

			return true;
		}
	case SUB_GP_QUERY_INDIVIDUAL:	//查询信息
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_GP_QueryIndividual));
			if (wDataSize!=sizeof(CMD_GP_QueryIndividual)) return false;

			//处理消息
			CMD_GP_QueryIndividual * pQueryIndividual=(CMD_GP_QueryIndividual *)pData;

			//变量定义
			DBR_GP_QueryIndividual QueryIndividual;
			ZeroMemory(&QueryIndividual,sizeof(QueryIndividual));

			//构造数据
			QueryIndividual.dwUserID=pQueryIndividual->dwUserID;
			QueryIndividual.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_QUERY_INDIVIDUAL,dwSocketID,&QueryIndividual,sizeof(QueryIndividual));

			return true;
		}
	case SUB_GP_MODIFY_INDIVIDUAL:	//修改资料
		{
			//效验参数
			ASSERT(wDataSize>=sizeof(CMD_GP_ModifyIndividual));
			if (wDataSize<sizeof(CMD_GP_ModifyIndividual)) return false;

			//处理消息
			CMD_GP_ModifyIndividual * pModifyIndividual=(CMD_GP_ModifyIndividual *)pData;
			pModifyIndividual->szPassword[CountArray(pModifyIndividual->szPassword)-1]=0;

			//变量定义
			DBR_GP_ModifyIndividual ModifyIndividual;
			ZeroMemory(&ModifyIndividual,sizeof(ModifyIndividual));

			//设置变量
			ModifyIndividual.dwUserID=pModifyIndividual->dwUserID;
			ModifyIndividual.cbGender=pModifyIndividual->cbGender;
			ModifyIndividual.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
			lstrcpyn(ModifyIndividual.szPassword,pModifyIndividual->szPassword,CountArray(ModifyIndividual.szPassword));

			//变量定义
			VOID * pDataBuffer=NULL;
			tagDataDescribe DataDescribe;
			CRecvPacketHelper RecvPacket(pModifyIndividual+1,wDataSize-sizeof(CMD_GP_ModifyIndividual));

			//扩展信息
			while (true)
			{
				pDataBuffer=RecvPacket.GetData(DataDescribe);
				if (DataDescribe.wDataDescribe==DTP_NULL) break;
				switch (DataDescribe.wDataDescribe)
				{
				case DTP_GP_UI_NICKNAME:		//用户昵称
					{
						ASSERT(pDataBuffer!=NULL);
						ASSERT(DataDescribe.wDataSize<=sizeof(ModifyIndividual.szNickName));
						if (DataDescribe.wDataSize<=sizeof(ModifyIndividual.szNickName))
						{
							CopyMemory(&ModifyIndividual.szNickName,pDataBuffer,DataDescribe.wDataSize);
							ModifyIndividual.szNickName[CountArray(ModifyIndividual.szNickName)-1]=0;
						}
						break;
					}
				case DTP_GP_UI_UNDER_WRITE:		//个性签名
					{
						ASSERT(pDataBuffer!=NULL);
						ASSERT(DataDescribe.wDataSize<=sizeof(ModifyIndividual.szUnderWrite));
						if (DataDescribe.wDataSize<=sizeof(ModifyIndividual.szUnderWrite))
						{
							CopyMemory(&ModifyIndividual.szUnderWrite,pDataBuffer,DataDescribe.wDataSize);
							ModifyIndividual.szUnderWrite[CountArray(ModifyIndividual.szUnderWrite)-1]=0;
						}
						break;
					}
				case DTP_GP_UI_USER_NOTE:		//用户备注
					{
						ASSERT(pDataBuffer!=NULL);
						ASSERT(DataDescribe.wDataSize<=sizeof(ModifyIndividual.szUserNote));
						if (DataDescribe.wDataSize<=sizeof(ModifyIndividual.szUserNote))
						{
							CopyMemory(&ModifyIndividual.szUserNote,pDataBuffer,DataDescribe.wDataSize);
							ModifyIndividual.szUserNote[CountArray(ModifyIndividual.szUserNote)-1]=0;
						}
						break;
					}
				case DTP_GP_UI_COMPELLATION:	//真实名字
					{
						ASSERT(pDataBuffer!=NULL);
						ASSERT(DataDescribe.wDataSize<=sizeof(ModifyIndividual.szCompellation));
						if (DataDescribe.wDataSize<=sizeof(ModifyIndividual.szCompellation))
						{
							CopyMemory(&ModifyIndividual.szCompellation,pDataBuffer,DataDescribe.wDataSize);
							ModifyIndividual.szCompellation[CountArray(ModifyIndividual.szCompellation)-1]=0;
						}
						break;
					}
				case DTP_GP_UI_SEAT_PHONE:		//固定电话
					{
						ASSERT(pDataBuffer!=NULL);
						ASSERT(DataDescribe.wDataSize<=sizeof(ModifyIndividual.szSeatPhone));
						if (DataDescribe.wDataSize<=sizeof(ModifyIndividual.szSeatPhone))
						{
							CopyMemory(ModifyIndividual.szSeatPhone,pDataBuffer,DataDescribe.wDataSize);
							ModifyIndividual.szSeatPhone[CountArray(ModifyIndividual.szSeatPhone)-1]=0;
						}
						break;
					}
				case DTP_GP_UI_MOBILE_PHONE:	//移动电话
					{
						ASSERT(pDataBuffer!=NULL);
						ASSERT(DataDescribe.wDataSize<=sizeof(ModifyIndividual.szMobilePhone));
						if (DataDescribe.wDataSize<=sizeof(ModifyIndividual.szMobilePhone))
						{
							CopyMemory(ModifyIndividual.szMobilePhone,pDataBuffer,DataDescribe.wDataSize);
							ModifyIndividual.szMobilePhone[CountArray(ModifyIndividual.szMobilePhone)-1]=0;
						}
						break;
					}
				case DTP_GP_UI_QQ:				//Q Q 号码
					{
						ASSERT(pDataBuffer!=NULL);
						ASSERT(DataDescribe.wDataSize<=sizeof(ModifyIndividual.szQQ));
						if (DataDescribe.wDataSize<=sizeof(ModifyIndividual.szQQ))
						{
							CopyMemory(ModifyIndividual.szQQ,pDataBuffer,DataDescribe.wDataSize);
							ModifyIndividual.szQQ[CountArray(ModifyIndividual.szQQ)-1]=0;
						}
						break;
					}
				case DTP_GP_UI_EMAIL:			//电子邮件
					{
						ASSERT(pDataBuffer!=NULL);
						ASSERT(DataDescribe.wDataSize<=sizeof(ModifyIndividual.szEMail));
						if (DataDescribe.wDataSize<=sizeof(ModifyIndividual.szEMail))
						{
							CopyMemory(ModifyIndividual.szEMail,pDataBuffer,DataDescribe.wDataSize);
							ModifyIndividual.szEMail[CountArray(ModifyIndividual.szEMail)-1]=0;
						}
						break;
					}
				case DTP_GP_UI_DWELLING_PLACE:	//联系地址
					{
						ASSERT(pDataBuffer!=NULL);
						ASSERT(DataDescribe.wDataSize<=sizeof(ModifyIndividual.szDwellingPlace));
						if (DataDescribe.wDataSize<=sizeof(ModifyIndividual.szDwellingPlace))
						{
							CopyMemory(ModifyIndividual.szDwellingPlace,pDataBuffer,DataDescribe.wDataSize);
							ModifyIndividual.szDwellingPlace[CountArray(ModifyIndividual.szDwellingPlace)-1]=0;
						}
						break;
					}
				}
			}

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_MODIFY_INDIVIDUAL,dwSocketID,&ModifyIndividual,sizeof(ModifyIndividual));

			return true;
		}
	case SUB_GP_USER_SAVE_SCORE:	//存入游戏币
		{
			//取出游戏币
			return OnTCPNetworkUserSaveScore(wSubCmdID, pData, wDataSize, dwSocketID);
		}
	case SUB_GP_USER_TAKE_SCORE:	//取出游戏币
		{
			//取出游戏币
			return OnTCPNetworkUserTakeScore(wSubCmdID, pData, wDataSize, dwSocketID);
		}
	case SUB_GP_USER_TRANSFER_SCORE:
		{
			// 转账游戏币
			return OnTCPNetworkUserTransferScore(wSubCmdID, pData, wDataSize, dwSocketID);
		}
	case SUB_GP_QUERY_INSURE_INFO:	
		{
			//查询银行
			return OnTCPNetworkQueryInsureInfo(wSubCmdID, pData, wDataSize, dwSocketID);
		}
    case SUB_GP_QUERY_TRANSRECORD:
        {
            //效验参数
            ASSERT(wDataSize==sizeof(CMD_GP_QueryInsureInfo));
            if (wDataSize!=sizeof(CMD_GP_QueryInsureInfo)) return false;

            //处理消息
            CMD_GP_QueryInsureInfo * pQueryInsureInfo=(CMD_GP_QueryInsureInfo *)pData;

            //变量定义
            DBR_GP_QueryInsureInfo QueryInsureInfo;
            ZeroMemory(&QueryInsureInfo,sizeof(QueryInsureInfo));

            //构造数据
            QueryInsureInfo.dwUserID=pQueryInsureInfo->dwUserID;
            QueryInsureInfo.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;

            //投递请求
            m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_QUERY_TRANSRECORD,dwSocketID,&QueryInsureInfo,sizeof(QueryInsureInfo));
            return true;
        }
	case SUB_GP_QUERY_USER_INFO_REQUEST:  //查询用户
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_GP_QueryUserInfoRequest));
			if (wDataSize!=sizeof(CMD_GP_QueryUserInfoRequest)) return false;

			//处理消息
			CMD_GP_QueryUserInfoRequest * pQueryUserInfoRequest=(CMD_GP_QueryUserInfoRequest *)pData;

			//变量定义
			DBR_GP_QueryInsureUserInfo QueryInsureUserInfo;
			ZeroMemory(&QueryInsureUserInfo,sizeof(QueryInsureUserInfo));

			//构造数据
			QueryInsureUserInfo.cbByNickName=pQueryUserInfoRequest->cbByNickName;
			lstrcpyn(QueryInsureUserInfo.szNickName,pQueryUserInfoRequest->szNickName,CountArray(QueryInsureUserInfo.szNickName));

			//投递请求
			m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_QUERY_USER_INFO,dwSocketID,&QueryInsureUserInfo,sizeof(QueryInsureUserInfo));

			return true;
		}
	case SUB_GP_QUERY_NICKNAME_BY_GAMEID:	
		{
			// 通过GameID查询昵称
			return OnTCPNetworkQueryNicknameByGameID(wSubCmdID, pData, wDataSize, dwSocketID);
		}
		break;
	case SUB_GP_VERIFY_INSURE_PASSWORD:		
		{
			// 验证银行密码
			return OnTCPNetworkVerifyInsurePassword(wSubCmdID, pData, wDataSize, dwSocketID);
		}
	case SUB_GP_QUERY_EXCHANGE_LOVELINESS:
		{
			// 查询魅力兑换信息
			return OnTCPNetworkQueryExchangeLoveliness(wSubCmdID, pData, wDataSize, dwSocketID);
		}
	case SUB_GP_EXCHANGE_LOVELINESS:
		{
			// 发起兑换
			return OnTCPNetworkExchangeLoveliness(wSubCmdID, pData, wDataSize, dwSocketID);
		}
		break;
	case SUB_MB_SHARE_SUCCESS:
		{
			// 分享成功
			return OnTCPNetworkMBShareSuccess(wSubCmdID, pData, wDataSize, dwSocketID);
		}
	case SUB_MB_USER_CUSTOM_TABLE:
		{
			// 创建自建桌子
			return OnTCPNetworkUserCreateCustomTable(wSubCmdID, pData, wDataSize, dwSocketID);
		}
	case SUB_MB_USER_JOIN_CUSTOMTABLE:
		{
			// 加入自建桌子
			return OnTCPNetworkUserJoinCustomTable(wSubCmdID, pData, wDataSize, dwSocketID);
		}
	case SUB_MB_USER_QUERY_CUSTOMTABLE:
		{
			// 查询加入的自建桌子信息
			return OnTCPNetworkUserQueryCustomTable(wSubCmdID, pData, wDataSize, dwSocketID);
		}
	case SUB_MB_USER_TRANSFER_DIAMOND:
		{
			// 查询加入的自建桌子信息
			return OnTCPNetworkUserTransferDiamond(wSubCmdID, pData, wDataSize, dwSocketID);
		}
	}

	return false;
}

//远程处理
bool CAttemperEngineSink::OnTCPNetworkMainPCRemoteService(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	switch (wSubCmdID)
	{
	case SUB_GP_C_SEARCH_CORRESPOND:	//协调查找
		{
			//效验参数
			ASSERT(wDataSize==sizeof(CMD_GP_C_SearchCorrespond));
			if (wDataSize!=sizeof(CMD_GP_C_SearchCorrespond)) return false;

			//处理消息
			CMD_GP_C_SearchCorrespond * pSearchCorrespond=(CMD_GP_C_SearchCorrespond *)pData;
			pSearchCorrespond->szNickName[CountArray(pSearchCorrespond->szNickName)-1]=0;

			//变量定义
			CMD_CS_C_SearchCorrespond SearchCorrespond;
			ZeroMemory(&SearchCorrespond,sizeof(SearchCorrespond));

			//连接变量
			SearchCorrespond.dwSocketID=dwSocketID;
			SearchCorrespond.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;

			//查找变量
			SearchCorrespond.dwGameID=pSearchCorrespond->dwGameID;
			lstrcpyn(SearchCorrespond.szNickName,pSearchCorrespond->szNickName,CountArray(SearchCorrespond.szNickName));

			//发送数据
			m_pITCPSocketService->SendData(MDM_CS_REMOTE_SERVICE,SUB_CS_C_SEARCH_CORRESPOND,&SearchCorrespond,sizeof(SearchCorrespond));

			return true;
		}
	}

	return false;
}

//登录处理
bool CAttemperEngineSink::OnTCPNetworkMainMBLogon(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	switch (wSubCmdID)
	{
	case SUB_GP_LOGON_GAMEID:		//I D 登录
		{
			return OnTCPNetworkSubMBLogonGameID(pData,wDataSize,dwSocketID);
		}
	case SUB_GP_LOGON_ACCOUNTS:		//帐号登录
		{
			return OnTCPNetworkSubMBLogonAccounts(pData,wDataSize,dwSocketID);
		}
	case SUB_MB_REGISTER_ACCOUNTS:	//帐号注册
		{
			return OnTCPNetworkSubMBRegisterAccounts(pData,wDataSize,dwSocketID);
		}
	case SUB_LOGON_THIRDPARTY:		//第三方登录
		{
			return OnTCPNetworkSubLogonThirdParty(pData, wDataSize, dwSocketID);
		}
	}

	return false;
}

//列表处理
bool CAttemperEngineSink::OnTCPNetworkMainMBServerList(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	return false;
}

// 请求系统文字信息
bool CAttemperEngineSink::OnTCPNetworkMainMBSystemMessage(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	switch (wSubCmdID)
	{
	case SUB_MB_RECHARGE_MESSAGE:			//充值公告
		{
			return OnTCPNetworkSubMBRechargeMessage(pData,wDataSize,dwSocketID);
		}
	case SUB_MB_CUSTOM_SERVICE_MESSAGE:		//客服公告
		{
			return OnTCPNetworkSubMBServiceMessage(pData,wDataSize,dwSocketID);
		}
	}
	return false;
}

//I D 登录
bool CAttemperEngineSink::OnTCPNetworkSubPCLogonGameID(VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	//效验参数
	ASSERT(wDataSize>=sizeof(CMD_GP_LogonGameID));
	if (wDataSize<sizeof(CMD_GP_LogonGameID))
	{
		if (wDataSize<sizeof(CMD_GP_LogonGameID)-sizeof(BYTE))
			return false;
	}

	//变量定义
	WORD wBindIndex=LOWORD(dwSocketID);
	tagBindParameter * pBindParameter=(m_pBindParameter+wBindIndex);

	//处理消息
	CMD_GP_LogonGameID * pLogonGameID=(CMD_GP_LogonGameID *)pData;
	pLogonGameID->szPassword[CountArray(pLogonGameID->szPassword)-1]=0;
	pLogonGameID->szMachineID[CountArray(pLogonGameID->szMachineID)-1]=0;

	//设置连接
//	pBindParameter->cbClientKind=CLIENT_KIND_COMPUTER;
	pBindParameter->dwPlazaVersion=pLogonGameID->dwPlazaVersion;
	pBindParameter->wPlatformID = CC_PLATFORM_WIN32;

	//效验版本
	if (CheckPlazaVersion(DEVICE_TYPE_PC,pLogonGameID->dwPlazaVersion,dwSocketID,((pLogonGameID->cbValidateFlags&LOW_VER_VALIDATE_FLAGS)!=0))==false)
	{
		return true;
	}

	//变量定义
	DBR_GP_LogonGameID LogonGameID;
	ZeroMemory(&LogonGameID,sizeof(LogonGameID));

	//附加信息
	LogonGameID.pBindParameter=(m_pBindParameter+LOWORD(dwSocketID));

	//构造数据
	LogonGameID.dwGameID=pLogonGameID->dwGameID;
	LogonGameID.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
	lstrcpyn(LogonGameID.szPassword,pLogonGameID->szPassword,CountArray(LogonGameID.szPassword));
	lstrcpyn(LogonGameID.szMachineID,pLogonGameID->szMachineID,CountArray(LogonGameID.szMachineID));
	LogonGameID.cbNeeValidateMBCard=(pLogonGameID->cbValidateFlags&MB_VALIDATE_FLAGS);

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_LOGON_GAMEID,dwSocketID,&LogonGameID,sizeof(LogonGameID));

	return true;
}

//帐号登录
bool CAttemperEngineSink::OnTCPNetworkSubPCLogonAccounts(VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	LOGI("CAttemperEngineSink::OnTCPNetworkSubPCLogonAccounts, Begin="<<GetTickCount());
	//效验参数
	ASSERT(wDataSize>=sizeof(CMD_GP_LogonAccounts));
	if (wDataSize<sizeof(CMD_GP_LogonAccounts))
	{
		if (wDataSize<sizeof(CMD_GP_LogonAccounts)-sizeof(BYTE))
			return false;
	}

	//变量定义
	WORD wBindIndex=LOWORD(dwSocketID);
	tagBindParameter * pBindParameter=(m_pBindParameter+wBindIndex);

	//处理消息
	CMD_GP_LogonAccounts * pLogonAccounts=(CMD_GP_LogonAccounts *)pData;
	pLogonAccounts->szAccounts[CountArray(pLogonAccounts->szAccounts)-1]=0;
	pLogonAccounts->szPassword[CountArray(pLogonAccounts->szPassword)-1]=0;
	pLogonAccounts->szMachineID[CountArray(pLogonAccounts->szMachineID)-1]=0;

	//设置连接
//	pBindParameter->cbClientKind=CLIENT_KIND_COMPUTER;
	pBindParameter->dwPlazaVersion=pLogonAccounts->dwPlazaVersion;
	pBindParameter->wPlatformID = CC_PLATFORM_WIN32;

	//版本判断
	if (CheckPlazaVersion(DEVICE_TYPE_PC,pLogonAccounts->dwPlazaVersion,dwSocketID,((pLogonAccounts->cbValidateFlags&LOW_VER_VALIDATE_FLAGS)!=0))==false)
	{
		return true;
	}

	//变量定义
	DBR_GP_LogonAccounts LogonAccounts;
	ZeroMemory(&LogonAccounts,sizeof(LogonAccounts));

	//附加信息
	LogonAccounts.pBindParameter=(m_pBindParameter+LOWORD(dwSocketID));

	//构造数据
	LogonAccounts.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
	lstrcpyn(LogonAccounts.szAccounts,pLogonAccounts->szAccounts,CountArray(LogonAccounts.szAccounts));
	lstrcpyn(LogonAccounts.szPassword,pLogonAccounts->szPassword,CountArray(LogonAccounts.szPassword));
	lstrcpyn(LogonAccounts.szMachineID,pLogonAccounts->szMachineID,CountArray(LogonAccounts.szMachineID));
	LogonAccounts.cbNeeValidateMBCard=(pLogonAccounts->cbValidateFlags&MB_VALIDATE_FLAGS);

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_LOGON_ACCOUNTS,dwSocketID,&LogonAccounts,sizeof(LogonAccounts));
	LOGI("CAttemperEngineSink::OnTCPNetworkSubPCLogonAccounts, End="<<GetTickCount());

	return true;
}

//帐号注册
bool CAttemperEngineSink::OnTCPNetworkSubPCRegisterAccounts(VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	//效验参数
	ASSERT(wDataSize>=sizeof(CMD_GP_RegisterAccounts));
	if (wDataSize<sizeof(CMD_GP_RegisterAccounts))
	{
		if (wDataSize<sizeof(CMD_GP_RegisterAccounts)-sizeof(BYTE))
			return false;
	}

	//变量定义
	WORD wBindIndex=LOWORD(dwSocketID);
	tagBindParameter * pBindParameter=(m_pBindParameter+wBindIndex);

	//处理消息
	CMD_GP_RegisterAccounts * pRegisterAccounts=(CMD_GP_RegisterAccounts *)pData;
	pRegisterAccounts->szAccounts[CountArray(pRegisterAccounts->szAccounts)-1]=0;
	pRegisterAccounts->szNickName[CountArray(pRegisterAccounts->szNickName)-1]=0;
	pRegisterAccounts->szSpreader[CountArray(pRegisterAccounts->szSpreader)-1]=0;
	pRegisterAccounts->szMachineID[CountArray(pRegisterAccounts->szMachineID)-1]=0;
	pRegisterAccounts->szLogonPass[CountArray(pRegisterAccounts->szLogonPass)-1]=0;
	pRegisterAccounts->szInsurePass[CountArray(pRegisterAccounts->szInsurePass)-1]=0;
	pRegisterAccounts->szPassPortID[CountArray(pRegisterAccounts->szPassPortID)-1]=0;
	pRegisterAccounts->szCompellation[CountArray(pRegisterAccounts->szCompellation)-1]=0;
	pRegisterAccounts->szMobile[CountArray(pRegisterAccounts->szMobile)-1]=0;

	//设置连接
//	pBindParameter->cbClientKind=CLIENT_KIND_COMPUTER;
	pBindParameter->dwPlazaVersion=pRegisterAccounts->dwPlazaVersion;
	pBindParameter->wPlatformID = CC_PLATFORM_WIN32;

	//效验版本
	if (CheckPlazaVersion(DEVICE_TYPE_PC,pRegisterAccounts->dwPlazaVersion,dwSocketID,((pRegisterAccounts->cbValidateFlags&LOW_VER_VALIDATE_FLAGS)!=0))==false)
	{
		return true;
	}

	//变量定义
	DBR_GP_RegisterAccounts RegisterAccounts;
	ZeroMemory(&RegisterAccounts,sizeof(RegisterAccounts));

	//附加信息
	RegisterAccounts.pBindParameter=(m_pBindParameter+LOWORD(dwSocketID));

	//构造数据
	RegisterAccounts.wFaceID=pRegisterAccounts->wFaceID;
	RegisterAccounts.cbGender=pRegisterAccounts->cbGender;
	RegisterAccounts.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
	lstrcpyn(RegisterAccounts.szAccounts,pRegisterAccounts->szAccounts,CountArray(RegisterAccounts.szAccounts));
	lstrcpyn(RegisterAccounts.szNickName,pRegisterAccounts->szNickName,CountArray(RegisterAccounts.szNickName));
	lstrcpyn(RegisterAccounts.szSpreader,pRegisterAccounts->szSpreader,CountArray(RegisterAccounts.szSpreader));
	lstrcpyn(RegisterAccounts.szMachineID,pRegisterAccounts->szMachineID,CountArray(RegisterAccounts.szMachineID));
	lstrcpyn(RegisterAccounts.szLogonPass,pRegisterAccounts->szLogonPass,CountArray(RegisterAccounts.szLogonPass));
	lstrcpyn(RegisterAccounts.szInsurePass,pRegisterAccounts->szInsurePass,CountArray(RegisterAccounts.szInsurePass));
	lstrcpyn(RegisterAccounts.szPassPortID,pRegisterAccounts->szPassPortID,CountArray(RegisterAccounts.szPassPortID));
	lstrcpyn(RegisterAccounts.szCompellation,pRegisterAccounts->szCompellation,CountArray(RegisterAccounts.szCompellation));
	//lstrcpyn(RegisterAccounts.szMobile,pRegisterAccounts->szMobile,CountArray(RegisterAccounts.szMobile));

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_REGISTER_ACCOUNTS,dwSocketID,&RegisterAccounts,sizeof(RegisterAccounts));

	return true;
}

//I D 登录
bool CAttemperEngineSink::OnTCPNetworkSubMBLogonGameID(VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	//效验参数
	ASSERT(wDataSize>=sizeof(CMD_MB_LogonGameID));
	if (wDataSize<sizeof(CMD_MB_LogonGameID)) return false;

	//变量定义
	WORD wBindIndex=LOWORD(dwSocketID);
	tagBindParameter * pBindParameter=(m_pBindParameter+wBindIndex);

	//处理消息
	CMD_MB_LogonGameID * pLogonGameID=(CMD_MB_LogonGameID *)pData;
	pLogonGameID->szPassword[CountArray(pLogonGameID->szPassword)-1]=0;
	pLogonGameID->szMachineID[CountArray(pLogonGameID->szMachineID)-1]=0;
	pLogonGameID->szMobilePhone[CountArray(pLogonGameID->szMobilePhone)-1]=0;

	//设置连接
//	pBindParameter->cbClientKind=CLIENT_KIND_MOBILE;
	pBindParameter->wModuleID=pLogonGameID->wModuleID;
	pBindParameter->dwPlazaVersion=pLogonGameID->dwPlazaVersion;
	pBindParameter->wPlatformID = DeviceTypeToPlatformID(pLogonGameID->cbDeviceType);

	//效验版本
	if (CheckPlazaVersion(pLogonGameID->cbDeviceType,pLogonGameID->dwPlazaVersion,dwSocketID)==false) return true;

	//变量定义
	DBR_MB_LogonGameID LogonGameID;
	ZeroMemory(&LogonGameID,sizeof(LogonGameID));

	//附加信息
	LogonGameID.pBindParameter=(m_pBindParameter+LOWORD(dwSocketID));

	//构造数据
	LogonGameID.dwGameID=pLogonGameID->dwGameID;
	LogonGameID.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
	lstrcpyn(LogonGameID.szPassword,pLogonGameID->szPassword,CountArray(LogonGameID.szPassword));
	lstrcpyn(LogonGameID.szMachineID,pLogonGameID->szMachineID,CountArray(LogonGameID.szMachineID));
	lstrcpyn(LogonGameID.szMobilePhone,pLogonGameID->szMobilePhone,CountArray(LogonGameID.szMobilePhone));

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_MB_LOGON_GAMEID,dwSocketID,&LogonGameID,sizeof(LogonGameID));

	return true;
}

//帐号登录
bool CAttemperEngineSink::OnTCPNetworkSubMBLogonAccounts(VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	//效验参数
	ASSERT(wDataSize>=sizeof(CMD_MB_LogonAccounts));
	if (wDataSize<sizeof(CMD_MB_LogonAccounts)) return false;

	//变量定义
	WORD wBindIndex=LOWORD(dwSocketID);
	tagBindParameter * pBindParameter=(m_pBindParameter+wBindIndex);

	//处理消息
	CMD_MB_LogonAccounts * pLogonAccounts=(CMD_MB_LogonAccounts *)pData;
	pLogonAccounts->szAccounts[CountArray(pLogonAccounts->szAccounts)-1]=0;
	pLogonAccounts->szPassword[CountArray(pLogonAccounts->szPassword)-1]=0;
	pLogonAccounts->szMachineID[CountArray(pLogonAccounts->szMachineID)-1]=0;
	pLogonAccounts->szMobilePhone[CountArray(pLogonAccounts->szMobilePhone)-1]=0;

	//设置连接
//	pBindParameter->cbClientKind=CLIENT_KIND_MOBILE;
	pBindParameter->wModuleID=pLogonAccounts->wModuleID;
	pBindParameter->dwPlazaVersion=pLogonAccounts->dwPlazaVersion;
	pBindParameter->wPlatformID = DeviceTypeToPlatformID(pLogonAccounts->cbDeviceType);

	//版本判断
	if (CheckPlazaVersion(pLogonAccounts->cbDeviceType,pLogonAccounts->dwPlazaVersion,dwSocketID)==false) return true;

	//变量定义
	DBR_MB_LogonAccounts LogonAccounts;
	ZeroMemory(&LogonAccounts,sizeof(LogonAccounts));

	//附加信息
	LogonAccounts.pBindParameter=(m_pBindParameter+LOWORD(dwSocketID));

	//构造数据
	LogonAccounts.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
	lstrcpyn(LogonAccounts.szAccounts,pLogonAccounts->szAccounts,CountArray(LogonAccounts.szAccounts));
	lstrcpyn(LogonAccounts.szPassword,pLogonAccounts->szPassword,CountArray(LogonAccounts.szPassword));
	lstrcpyn(LogonAccounts.szMachineID,pLogonAccounts->szMachineID,CountArray(LogonAccounts.szMachineID));
	lstrcpyn(LogonAccounts.szMobilePhone,pLogonAccounts->szMobilePhone,CountArray(LogonAccounts.szMobilePhone));

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_MB_LOGON_ACCOUNTS,dwSocketID,&LogonAccounts,sizeof(LogonAccounts));

	return true;
}

//帐号注册
bool CAttemperEngineSink::OnTCPNetworkSubMBRegisterAccounts(VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	//效验参数
	ASSERT(wDataSize>=sizeof(CMD_MB_RegisterAccounts));
	if (wDataSize<sizeof(CMD_MB_RegisterAccounts)) return false;

	//变量定义
	WORD wBindIndex=LOWORD(dwSocketID);
	tagBindParameter * pBindParameter=(m_pBindParameter+wBindIndex);

	//处理消息
	CMD_MB_RegisterAccounts * pRegisterAccounts=(CMD_MB_RegisterAccounts *)pData;
	pRegisterAccounts->szAccounts[CountArray(pRegisterAccounts->szAccounts)-1]=0;
	pRegisterAccounts->szNickName[CountArray(pRegisterAccounts->szNickName)-1]=0;
	pRegisterAccounts->szMachineID[CountArray(pRegisterAccounts->szMachineID)-1]=0;
	pRegisterAccounts->szLogonPass[CountArray(pRegisterAccounts->szLogonPass)-1]=0;
	pRegisterAccounts->szInsurePass[CountArray(pRegisterAccounts->szInsurePass)-1]=0;
	pRegisterAccounts->szMobilePhone[CountArray(pRegisterAccounts->szMobilePhone)-1]=0;

	//设置连接
//	pBindParameter->cbClientKind=CLIENT_KIND_MOBILE;
	pBindParameter->wModuleID=pRegisterAccounts->wModuleID;
	pBindParameter->dwPlazaVersion=pRegisterAccounts->dwPlazaVersion;
	pBindParameter->wPlatformID = DeviceTypeToPlatformID(pRegisterAccounts->cbDeviceType);

	//效验版本
	if (CheckPlazaVersion(pRegisterAccounts->cbDeviceType,pRegisterAccounts->dwPlazaVersion,dwSocketID)==false) return true;

	//变量定义
	DBR_MB_RegisterAccounts RegisterAccounts;
	ZeroMemory(&RegisterAccounts,sizeof(RegisterAccounts));

	//附加信息
	RegisterAccounts.pBindParameter=(m_pBindParameter+LOWORD(dwSocketID));

	//构造数据
	RegisterAccounts.wFaceID=pRegisterAccounts->wFaceID;
	RegisterAccounts.cbGender=pRegisterAccounts->cbGender;
	RegisterAccounts.dwAreaID = pRegisterAccounts->dwAreaID;
	RegisterAccounts.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
	lstrcpyn(RegisterAccounts.szAccounts,pRegisterAccounts->szAccounts,CountArray(RegisterAccounts.szAccounts));
	lstrcpyn(RegisterAccounts.szNickName,pRegisterAccounts->szNickName,CountArray(RegisterAccounts.szNickName));
	lstrcpyn(RegisterAccounts.szMachineID,pRegisterAccounts->szMachineID,CountArray(RegisterAccounts.szMachineID));
	lstrcpyn(RegisterAccounts.szLogonPass,pRegisterAccounts->szLogonPass,CountArray(RegisterAccounts.szLogonPass));
	lstrcpyn(RegisterAccounts.szInsurePass,pRegisterAccounts->szInsurePass,CountArray(RegisterAccounts.szInsurePass));
	lstrcpyn(RegisterAccounts.szMobilePhone,pRegisterAccounts->szMobilePhone,CountArray(RegisterAccounts.szMobilePhone));

	LOGI("CAttemperEngineSink::OnTCPNetworkSubMBRegisterAccounts szAccounts=" << pRegisterAccounts->szAccounts << ", dwAreaID=" << pRegisterAccounts->dwAreaID);

	// 随机产生头像
	CRandom random;
	RegisterAccounts.wFaceID = random.Random(8);

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_MB_REGISTER_ACCOUNTS,dwSocketID,&RegisterAccounts,sizeof(RegisterAccounts));

	return true;
}

// 请求充值公告
bool CAttemperEngineSink::OnTCPNetworkSubMBRechargeMessage(VOID * pData, WORD wDataSize, DWORD dwSocketID)
{

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_MB_RECHARGE_MESSAGE,dwSocketID,NULL,NULL);

	return true;
}

// 请求客服公告
bool CAttemperEngineSink::OnTCPNetworkSubMBServiceMessage(VOID * pData, WORD wDataSize, DWORD dwSocketID)
{

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_MB_CUSTOM_SERVICE_MESSAGE,dwSocketID,NULL,NULL);

	return true;
}

// 第三方登录
bool CAttemperEngineSink::OnTCPNetworkSubLogonThirdParty(VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	LOGI("CAttemperEngineSink::OnTCPNetworkSubLogonThirdParty");

	//效验参数
	ASSERT(wDataSize>=sizeof(CMD_LogonAccounts_ThirdParty));
	if (wDataSize<sizeof(CMD_LogonAccounts_ThirdParty)) return false;

	//变量定义
	WORD wBindIndex=LOWORD(dwSocketID);
	tagBindParameter * pBindParameter=(m_pBindParameter+wBindIndex);

	//处理消息
	CMD_LogonAccounts_ThirdParty * pThirdPartyAccounts=(CMD_LogonAccounts_ThirdParty *)pData;
	int i = CountArray(pThirdPartyAccounts->szSessionID);
	pThirdPartyAccounts->szSessionID[CountArray(pThirdPartyAccounts->szSessionID) - 1] = 0;
	pThirdPartyAccounts->szNickName[CountArray(pThirdPartyAccounts->szNickName) - 1] = 0;
	pThirdPartyAccounts->szMachineID[CountArray(pThirdPartyAccounts->szMachineID) - 1] = 0;

	LOGI("CAttemperEngineSink::OnTCPNetworkSubLogonThirdParty, szSessionID=" << pThirdPartyAccounts->szSessionID << ", szNickName=" << pThirdPartyAccounts->szNickName << \
		", dwAreaID=" << pThirdPartyAccounts->dwAreaID);

	//设置连接
//	pBindParameter->cbClientKind=pThirdPartyAccounts->cbDeviceType;
	pBindParameter->dwPlazaVersion=pThirdPartyAccounts->dwPlazaVersion;
	pBindParameter->wPlatformID = DeviceTypeToPlatformID(pThirdPartyAccounts->cbDeviceType);

	//效验版本
	if (CheckPlazaVersion(pThirdPartyAccounts->cbDeviceType,pThirdPartyAccounts->dwPlazaVersion,dwSocketID)==false) return true;

	//变量定义
 	DBR_TP_LogonAccounts LogonAccounts;
 	ZeroMemory(&LogonAccounts,sizeof(LogonAccounts));
 
 	//附加信息
 	LogonAccounts.pBindParameter=(m_pBindParameter+LOWORD(dwSocketID));
 
 	//构造数据
 	LogonAccounts.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;
	LogonAccounts.nThirdPartyID=pThirdPartyAccounts->nThirdPartyID;
	LogonAccounts.dwAreaID = pThirdPartyAccounts->dwAreaID;
 	lstrcpyn(LogonAccounts.szSessionID,pThirdPartyAccounts->szSessionID,CountArray(LogonAccounts.szSessionID));
	lstrcpyn(LogonAccounts.szNickName,pThirdPartyAccounts->szNickName,CountArray(LogonAccounts.szNickName));
	lstrcpyn(LogonAccounts.szMachineID, pThirdPartyAccounts->szMachineID, CountArray(LogonAccounts.szMachineID));

	// 随机产生头像
	CRandom random;
	LogonAccounts.wFaceID = random.Random(8);

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_TP_LOGON_ACCOUNTS,dwSocketID,&LogonAccounts,sizeof(LogonAccounts));

	return true;
}

//存入游戏币
bool CAttemperEngineSink::OnTCPNetworkUserSaveScore(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	//效验参数
	ASSERT(wDataSize == sizeof(CMD_GP_UserSaveScore));
	if (wDataSize != sizeof(CMD_GP_UserSaveScore)) return false;

	//处理消息
	CMD_GP_UserSaveScore * pUserSaveScore = (CMD_GP_UserSaveScore *)pData;
	pUserSaveScore->szMachineID[CountArray(pUserSaveScore->szMachineID) - 1] = 0;

	//变量定义
	DBR_GP_UserSaveScore UserSaveScore;
	ZeroMemory(&UserSaveScore, sizeof(UserSaveScore));

	//构造数据
	UserSaveScore.dwUserID = pUserSaveScore->dwUserID;
	UserSaveScore.lSaveScore = pUserSaveScore->lSaveScore;
	UserSaveScore.dwClientAddr = (m_pBindParameter + LOWORD(dwSocketID))->dwClientAddr;
	lstrcpyn(UserSaveScore.szMachineID, pUserSaveScore->szMachineID, CountArray(UserSaveScore.szMachineID));

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_USER_SAVE_SCORE, dwSocketID, &UserSaveScore, sizeof(UserSaveScore));

	return true;
}

//取出游戏币
bool CAttemperEngineSink::OnTCPNetworkUserTakeScore(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	//效验参数
	ASSERT(wDataSize == sizeof(CMD_GP_UserTakeScore));
	if (wDataSize != sizeof(CMD_GP_UserTakeScore)) return false;

	//处理消息
	CMD_GP_UserTakeScore * pUserTakeScore = (CMD_GP_UserTakeScore *)pData;
	pUserTakeScore->szPassword[CountArray(pUserTakeScore->szPassword) - 1] = 0;
	pUserTakeScore->szMachineID[CountArray(pUserTakeScore->szMachineID) - 1] = 0;

	//变量定义
	DBR_GP_UserTakeScore UserTakeScore;
	ZeroMemory(&UserTakeScore, sizeof(UserTakeScore));

	//构造数据
	UserTakeScore.dwUserID = pUserTakeScore->dwUserID;
	UserTakeScore.lTakeScore = pUserTakeScore->lTakeScore;
	UserTakeScore.dwClientAddr = (m_pBindParameter + LOWORD(dwSocketID))->dwClientAddr;
	lstrcpyn(UserTakeScore.szPassword, pUserTakeScore->szPassword, CountArray(UserTakeScore.szPassword));
	lstrcpyn(UserTakeScore.szMachineID, pUserTakeScore->szMachineID, CountArray(UserTakeScore.szMachineID));

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_USER_TAKE_SCORE, dwSocketID, &UserTakeScore, sizeof(UserTakeScore));

	return true;
}

// 转账游戏币
bool CAttemperEngineSink::OnTCPNetworkUserTransferScore(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	//效验参数
	ASSERT(wDataSize == sizeof(CMD_GP_UserTransferScore));
	if (wDataSize != sizeof(CMD_GP_UserTransferScore))
	{
		LOGI("CAttemperEngineSink::OnTCPNetworkMainPCUserService, wDataSize=" << wDataSize);
		return false;
	}

	//处理消息
	CMD_GP_UserTransferScore * pUserTransferScore = (CMD_GP_UserTransferScore *)pData;
	pUserTransferScore->szNickName[CountArray(pUserTransferScore->szNickName) - 1] = 0;
	pUserTransferScore->szPassword[CountArray(pUserTransferScore->szPassword) - 1] = 0;
	pUserTransferScore->szMachineID[CountArray(pUserTransferScore->szMachineID) - 1] = 0;

	//变量定义
	DBR_GP_UserTransferScore UserTransferScore;
	ZeroMemory(&UserTransferScore, sizeof(UserTransferScore));

	//构造数据
	UserTransferScore.dwUserID = pUserTransferScore->dwUserID;
	UserTransferScore.cbByNickName = pUserTransferScore->cbByNickName;
	UserTransferScore.lTransferScore = pUserTransferScore->lTransferScore;
	UserTransferScore.dwClientAddr = (m_pBindParameter + LOWORD(dwSocketID))->dwClientAddr;
	lstrcpyn(UserTransferScore.szNickName, pUserTransferScore->szNickName, CountArray(UserTransferScore.szNickName));
	lstrcpyn(UserTransferScore.szPassword, pUserTransferScore->szPassword, CountArray(UserTransferScore.szPassword));
	lstrcpyn(UserTransferScore.szMachineID, pUserTransferScore->szMachineID, CountArray(UserTransferScore.szMachineID));

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_USER_TRANSFER_SCORE, dwSocketID, &UserTransferScore, sizeof(UserTransferScore));

	return true;
}

//查询银行
bool CAttemperEngineSink::OnTCPNetworkQueryInsureInfo(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	//效验参数
	ASSERT(wDataSize == sizeof(CMD_GP_QueryInsureInfo));
	if (wDataSize != sizeof(CMD_GP_QueryInsureInfo)) return false;

	//处理消息
	CMD_GP_QueryInsureInfo * pQueryInsureInfo = (CMD_GP_QueryInsureInfo *)pData;

	//变量定义
	DBR_GP_QueryInsureInfo QueryInsureInfo;
	ZeroMemory(&QueryInsureInfo, sizeof(QueryInsureInfo));

	//构造数据
	QueryInsureInfo.dwUserID = pQueryInsureInfo->dwUserID;
	QueryInsureInfo.dwClientAddr = (m_pBindParameter + LOWORD(dwSocketID))->dwClientAddr;

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_QUERY_INSURE_INFO, dwSocketID, &QueryInsureInfo, sizeof(QueryInsureInfo));

	return true;
}

bool CAttemperEngineSink::OnTCPNetworkQueryNicknameByGameID(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	//效验参数
	ASSERT(wDataSize == sizeof(CMD_GP_QueryNickNameByGameID));
	if (wDataSize != sizeof(CMD_GP_QueryNickNameByGameID)) return false;

	//处理消息
	CMD_GP_QueryNickNameByGameID* pQueryNickNameByGameID = (CMD_GP_QueryNickNameByGameID *)pData;

	//变量定义
	DBR_GP_QueryNickNameByGameID QueryNickNameByGameID;
	ZeroMemory(&QueryNickNameByGameID, sizeof(QueryNickNameByGameID));

	//构造数据
	QueryNickNameByGameID.dwGameID = pQueryNickNameByGameID->dwGameID;
	//			QueryIndividual.dwClientAddr=(m_pBindParameter+LOWORD(dwSocketID))->dwClientAddr;

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_QUERY_NICKNAME_BY_GAMEID, dwSocketID, &QueryNickNameByGameID, sizeof(QueryNickNameByGameID));

	return true;
}

// 验证银行密码
bool CAttemperEngineSink::OnTCPNetworkVerifyInsurePassword(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	LOGI("CAttemperEngineSink::OnTCPNetworkVerifyInsurePassword SUB_GP_VERIFY_INSURE_PASSWORD");
	//效验参数
	ASSERT(wDataSize == sizeof(CMD_GP_VerifyUserInsurePassword));
	if (wDataSize != sizeof(CMD_GP_VerifyUserInsurePassword)) return false;

	//处理消息
	CMD_GP_VerifyUserInsurePassword* pVerifyUserInsurePassword = (CMD_GP_VerifyUserInsurePassword *)pData;

	//变量定义
	DBR_GP_VerifyInsurePassword VerifyInsurePassword;
	ZeroMemory(&VerifyInsurePassword, sizeof(VerifyInsurePassword));

	//构造数据
	VerifyInsurePassword.dwUserID = pVerifyUserInsurePassword->dwUserID;
	lstrcpyn(VerifyInsurePassword.szInsurePassword, pVerifyUserInsurePassword->szInsurePassword, CountArray(VerifyInsurePassword.szInsurePassword));

	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_VERIFY_INSURE_PASSWORD, dwSocketID, &VerifyInsurePassword, sizeof(VerifyInsurePassword));
	return true;
}

// 查询魅力兑换信息
bool CAttemperEngineSink::OnTCPNetworkQueryExchangeLoveliness(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	// 查询魅力兑换信息
	LOGI("CAttemperEngineSink::OnTCPNetworkQueryExchangeLoveliness SUB_GP_QUERY_EXCHANGE_LOVELINESS");

	//效验参数
	ASSERT(wDataSize == sizeof(CMD_GP_QueryExchangeLoveliness));
	if (wDataSize != sizeof(CMD_GP_QueryExchangeLoveliness)) return false;

	//处理消息
	CMD_GP_QueryExchangeLoveliness* pQueryExchangeLoveliness = (CMD_GP_QueryExchangeLoveliness *)pData;

	//变量定义
	DBR_GP_QueryExchangeLoveliness QueryExchangeLoveliness;
	ZeroMemory(&QueryExchangeLoveliness, sizeof(QueryExchangeLoveliness));

	//构造数据
	QueryExchangeLoveliness.dwUserID = pQueryExchangeLoveliness->dwUserID;

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_QUERY_EXCHANGE_LOVELINESS, dwSocketID, &QueryExchangeLoveliness, sizeof(QueryExchangeLoveliness));

	return true;
}

// 兑换魅力值
bool CAttemperEngineSink::OnTCPNetworkExchangeLoveliness(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	// 发起兑换
	LOGI("CAttemperEngineSink::OnTCPNetworkExchangeLoveliness SUB_GP_EXCHANGE_LOVELINESS");

	//处理消息
	CMD_GP_ExchangeLoveliness* pExchangeLoveliness = (CMD_GP_ExchangeLoveliness *)pData;

	//变量定义
	DBR_GP_ExchangeLoveliness ExchangeLoveliness;
	ZeroMemory(&ExchangeLoveliness, sizeof(ExchangeLoveliness));

	//构造数据
	ExchangeLoveliness.dwUserID = pExchangeLoveliness->dwUserID;
	ExchangeLoveliness.dwClientAddr = (m_pBindParameter + LOWORD(dwSocketID))->dwClientAddr;

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_GP_EXCHANGE_LOVELINESS, dwSocketID, &ExchangeLoveliness, sizeof(ExchangeLoveliness));

	return true;
}

// 分享成功
bool CAttemperEngineSink::OnTCPNetworkMBShareSuccess(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	LOGI("CAttemperEngineSink::OnTCPNetworkMainPCUserService SUB_MB_SHARE_SUCCESS");
	//效验参数
	ASSERT(wDataSize == sizeof(CMD_MB_ShareSuccess));
	if (wDataSize != sizeof(CMD_MB_ShareSuccess))
	{
		return false;
	}

	//处理消息
	CMD_MB_ShareSuccess* pShareSuccess = (CMD_MB_ShareSuccess*)pData;

	// 变量定义
	DBR_MB_ShareSuccess	DBRShareSucces;
	memset(&DBRShareSucces, 0, sizeof(DBRShareSucces));
	DBRShareSucces.dwUserID = pShareSuccess->dwUserID;
	lstrcpyn(DBRShareSucces.szMachineID, pShareSuccess->szMachineID, CountArray(DBRShareSucces.szMachineID));
	DBRShareSucces.dwClientAddr = (m_pBindParameter + LOWORD(dwSocketID))->dwClientAddr;
	DBRShareSucces.pBindParameter = (m_pBindParameter + LOWORD(dwSocketID));

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_MB_SHARE_SUCCESS, dwSocketID, &DBRShareSucces, sizeof(DBRShareSucces));

	return true;
}

// 创建房间
bool CAttemperEngineSink::OnTCPNetworkUserCreateCustomTable(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	// 用户自定义桌子
	LOGI("CAttemperEngineSink::OnTCPNetworkUserCreateCustomTable SUB_MB_USER_CUSTOM_TABLE");

	//效验参数
	ASSERT(wDataSize == sizeof(CMD_MB_UserCustomTable));
	if (wDataSize != sizeof(CMD_MB_UserCustomTable))
	{
		LOGI("CAttemperEngineSink::OnTCPNetworkUserCreateCustomTable SUB_MB_USER_CUSTOM_TABLE 消息长度不匹配");
		return false;
	}

	//处理消息
	CMD_MB_UserCustomTable* pUserCustomTable = (CMD_MB_UserCustomTable*)pData;

	// 变量定义
	CMD_CS_C_UserCustomTable	CSUserCustomTable;
	memset(&CSUserCustomTable, 0, sizeof(CMD_CS_C_UserCustomTable));
	CSUserCustomTable.dwUserID = pUserCustomTable->dwUserID;
	CSUserCustomTable.wKindID = pUserCustomTable->wKindID;										// 类型索引
	CSUserCustomTable.wCardCousumeCount = pUserCustomTable->wCardCousumeCount;					// 消耗的房卡数目
	memcpy(CSUserCustomTable.cbCustomRule, pUserCustomTable->cbCustomRule, sizeof(CSUserCustomTable.cbCustomRule));	// 自定规则
	CSUserCustomTable.dwSocketID = dwSocketID;

	// 转给协调服务器
	bool flag = m_pITCPSocketService->SendData(MDM_CS_REMOTE_SERVICE, SUB_CS_C_USER_CUSTOM_TABLE, &CSUserCustomTable, sizeof(CSUserCustomTable));
	if (flag == false)
	{
		// 发送消息给协调服务器失败
		CMD_MB_UserCustomTableFailed UserCustomTableFailed;
		lstrcpyn(UserCustomTableFailed.szDescribeString, TEXT("无法连接协调服务器,创建游戏房间失败!"), CountArray(UserCustomTableFailed.szDescribeString));
//		UserCustomTableFailed.bLockedInTable = false;

		//发送数据
		WORD wStringSize = CountStringBuffer(UserCustomTableFailed.szDescribeString);
		WORD wSendSize = sizeof(UserCustomTableFailed) - sizeof(UserCustomTableFailed.szDescribeString) + wStringSize;
		m_pITCPNetworkEngine->SendData(dwSocketID, MDM_GP_USER_SERVICE, SUB_MB_USER_CUSTOM_TABLE_FAILED, &UserCustomTableFailed, wSendSize);
	}

	return true;
}

// 加入自建房间
bool CAttemperEngineSink::OnTCPNetworkUserJoinCustomTable(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	// 用户加入自定义桌子
	LOGI("CAttemperEngineSink::OnTCPNetworkUserJoinCustomTable");

	//效验参数
	ASSERT(wDataSize == sizeof(CMD_MB_UserJoinCustomTable));
	if (wDataSize != sizeof(CMD_MB_UserJoinCustomTable))
	{
		LOGI("CAttemperEngineSink::OnTCPNetworkUserJoinCustomTable 消息长度不匹配");
		return false;
	}
	CMD_MB_UserJoinCustomTable* pUserJoinCustomTable = (CMD_MB_UserJoinCustomTable*)pData;

	//投递请求
	DBR_MB_UserJoinCustomTable UserJoinCustomTable;
	UserJoinCustomTable.dwUserID = pUserJoinCustomTable->dwUserID;
	lstrcpyn(UserJoinCustomTable.szSecret, pUserJoinCustomTable->szSecret, CountArray(UserJoinCustomTable.szSecret));
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_MB_USER_JOIN_CUSTOMTABLE, dwSocketID, &UserJoinCustomTable, sizeof(UserJoinCustomTable));

	return true;
}

// 查询加入的自建桌子
bool CAttemperEngineSink::OnTCPNetworkUserQueryCustomTable(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	LOGI("CAttemperEngineSink::OnTCPNetworkUserQueryCustomTable ");

	//效验参数
	ASSERT(wDataSize == sizeof(CMD_MB_UserQueryCustomTable));
	if (wDataSize != sizeof(CMD_MB_UserQueryCustomTable))
	{
		LOGI("CAttemperEngineSink::OnTCPNetworkUserQueryCustomTable 消息长度不匹配");
		return false;
	}
	CMD_MB_UserQueryCustomTable* pUserQueryCustomTable = (CMD_MB_UserQueryCustomTable*)pData;
	
	// 投递给数据库
	DBR_MB_UserQueryCustomTable UserQueryCustomTable;
	UserQueryCustomTable.dwUserID = pUserQueryCustomTable->dwUserID;
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_MB_USER_QUERY_CUSTOMTABLE, dwSocketID, &UserQueryCustomTable, sizeof(UserQueryCustomTable));

	return true;
}

// 用户转账钻石
bool CAttemperEngineSink::OnTCPNetworkUserTransferDiamond(WORD wSubCmdID, VOID * pData, WORD wDataSize, DWORD dwSocketID)
{
	LOGI("CAttemperEngineSink::OnTCPNetworkUserTransferDiamond ");

	//处理消息
	CMD_MB_UserTransferDiamond * pUserTransferDiamond = (CMD_MB_UserTransferDiamond *)pData;
	pUserTransferDiamond->szPassword[CountArray(pUserTransferDiamond->szPassword) - 1] = 0;
	pUserTransferDiamond->szMachineID[CountArray(pUserTransferDiamond->szMachineID) - 1] = 0;

	//变量定义
	DBR_MB_UserTransferDiamond UserTransferDiamond;
	ZeroMemory(&UserTransferDiamond, sizeof(UserTransferDiamond));

	//构造数据
	UserTransferDiamond.dwUserID = pUserTransferDiamond->dwUserID;
	UserTransferDiamond.dwGameID = pUserTransferDiamond->dwGameID;
	UserTransferDiamond.dwTransferDiamond = pUserTransferDiamond->dwTransferDiamond;
	UserTransferDiamond.dwClientAddr = (m_pBindParameter + LOWORD(dwSocketID))->dwClientAddr;
	lstrcpyn(UserTransferDiamond.szPassword, pUserTransferDiamond->szPassword, CountArray(UserTransferDiamond.szPassword));
	lstrcpyn(UserTransferDiamond.szMachineID, pUserTransferDiamond->szMachineID, CountArray(UserTransferDiamond.szMachineID));

	//投递请求
	m_pIDataBaseEngine->PostDataBaseRequest(DBR_MB_USER_TRANSFER_DIAMOND, dwSocketID, &UserTransferDiamond, sizeof(UserTransferDiamond));

	return true;
}

//登录成功
bool CAttemperEngineSink::OnDBPCLogonSuccess(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	LOGI("CAttemperEngineSink::OnDBPCLogonSuccess, Begin="<<GetTickCount());
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];
	DBO_GP_LogonSuccess * pDBOLogonSuccess=(DBO_GP_LogonSuccess *)pData;
	CMD_GP_LogonSuccess * pCMDLogonSuccess=(CMD_GP_LogonSuccess *)cbDataBuffer;

	//发送定义
	WORD wHeadSize=sizeof(CMD_GP_LogonSuccess);
	CSendPacketHelper SendPacket(cbDataBuffer+wHeadSize,sizeof(cbDataBuffer)-wHeadSize);

	//设置变量
	ZeroMemory(pCMDLogonSuccess,sizeof(CMD_GP_LogonSuccess));

	//构造数据
	pCMDLogonSuccess->wFaceID=pDBOLogonSuccess->wFaceID;
	pCMDLogonSuccess->cbGender=pDBOLogonSuccess->cbGender;
	pCMDLogonSuccess->dwGameID=pDBOLogonSuccess->dwGameID;
	pCMDLogonSuccess->dwUserID=pDBOLogonSuccess->dwUserID;
	pCMDLogonSuccess->dwCustomID=pDBOLogonSuccess->dwCustomID;
	pCMDLogonSuccess->dwUserMedal=pDBOLogonSuccess->dwUserMedal;
	pCMDLogonSuccess->dwExperience=pDBOLogonSuccess->dwExperience;
	pCMDLogonSuccess->dwLoveLiness=pDBOLogonSuccess->dwLoveLiness;
	pCMDLogonSuccess->cbMoorMachine=pDBOLogonSuccess->cbMoorMachine;
	lstrcpyn(pCMDLogonSuccess->szAccounts,pDBOLogonSuccess->szAccounts,CountArray(pCMDLogonSuccess->szAccounts));
	lstrcpyn(pCMDLogonSuccess->szNickName,pDBOLogonSuccess->szNickName,CountArray(pCMDLogonSuccess->szNickName));

	//用户游戏币
	pCMDLogonSuccess->lUserScore=pDBOLogonSuccess->lUserScore;
	pCMDLogonSuccess->lUserInsure=pDBOLogonSuccess->lUserInsure;

	//配置信息
	pCMDLogonSuccess->cbShowServerStatus=m_bShowServerStatus?1:0;

	//会员信息
	if (pDBOLogonSuccess->cbMemberOrder!=0)
	{
		DTP_GP_MemberInfo MemberInfo;
		ZeroMemory(&MemberInfo,sizeof(MemberInfo));
		MemberInfo.cbMemberOrder=pDBOLogonSuccess->cbMemberOrder;
		MemberInfo.MemberOverDate=pDBOLogonSuccess->MemberOverDate;
		SendPacket.AddPacket(&MemberInfo,sizeof(MemberInfo),DTP_GP_MEMBER_INFO);
	}
	LOGI("CAttemperEngineSink::OnDBPCLogonSuccess, Step 1="<<GetTickCount());

	//个性签名
	if (pDBOLogonSuccess->szUnderWrite[0]!=0)
	{
		SendPacket.AddPacket(pDBOLogonSuccess->szUnderWrite,CountStringBuffer(pDBOLogonSuccess->szUnderWrite),DTP_GP_UNDER_WRITE);
	}
	LOGI("CAttemperEngineSink::OnDBPCLogonSuccess, Step 2="<<GetTickCount());

	pCMDLogonSuccess->wFillIn = pDBOLogonSuccess->wFillIn;
	//登录成功
	WORD wSendSize=SendPacket.GetDataSize()+sizeof(CMD_GP_LogonSuccess);
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_LOGON,SUB_GP_LOGON_SUCCESS,cbDataBuffer,wSendSize);

	LOGI("CAttemperEngineSink::OnDBPCLogonSuccess, Step 3="<<GetTickCount());

	//发送列表
	if(pCMDLogonSuccess->wFillIn > 0)	// add by chenj
	{
		if (m_pInitParameter->m_cbDelayList==TRUE)
		{
			//发送列表
			SendGameTypeInfo(dwContextID);
			SendGameKindInfo(dwContextID);
			SendGamePageInfo(dwContextID,INVALID_WORD);
			SendGameNodeInfo(dwContextID,INVALID_WORD);
			SendGameServerInfo(dwContextID,INVALID_WORD);
			m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_SERVER_LIST,SUB_GP_LIST_FINISH);
			LOGI("CAttemperEngineSink::OnDBPCLogonSuccess, Step 4="<<GetTickCount());
		}
		else
		{
			SendGameTypeInfo(dwContextID);
			SendGameKindInfo(dwContextID);
			SendGamePageInfo(dwContextID,0);
			m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_SERVER_LIST,SUB_GP_LIST_FINISH);
			LOGI("CAttemperEngineSink::OnDBPCLogonSuccess, Step 5="<<GetTickCount());
		}
	}

	//登录完成
	CMD_GP_LogonFinish LogonFinish;
	ZeroMemory(&LogonFinish,sizeof(LogonFinish));
	LogonFinish.wIntermitTime=m_pInitParameter->m_wIntermitTime;
	LogonFinish.wOnLineCountTime=m_pInitParameter->m_wOnLineCountTime;
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_LOGON,SUB_GP_LOGON_FINISH,&LogonFinish,sizeof(LogonFinish));

	LOGI("CAttemperEngineSink::OnDBPCLogonSuccess, End="<<GetTickCount());

	return true;
}

//登录失败
bool CAttemperEngineSink::OnDBPCLogonFailure(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	CMD_GP_LogonFailure LogonFailure;
	ZeroMemory(&LogonFailure,sizeof(LogonFailure));
	DBO_GP_LogonFailure * pLogonFailure=(DBO_GP_LogonFailure *)pData;

	//构造数据
	LogonFailure.lResultCode=pLogonFailure->lResultCode;
	lstrcpyn(LogonFailure.szDescribeString,pLogonFailure->szDescribeString,CountArray(LogonFailure.szDescribeString));

	//发送数据
	WORD wStringSize=CountStringBuffer(LogonFailure.szDescribeString);
	WORD wSendSize=sizeof(LogonFailure)-sizeof(LogonFailure.szDescribeString)+wStringSize;
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_LOGON,SUB_GP_LOGON_FAILURE,&LogonFailure,wSendSize);

	//关闭连接(底层error,暂时不关闭连接)
//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);

	return true;
}

//登录失败
bool CAttemperEngineSink::OnDBPCLogonValidateMBCard(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//效验参数
	ASSERT(wDataSize==sizeof(DBR_GP_ValidateMBCard));
	if (wDataSize!=sizeof(DBR_GP_ValidateMBCard)) return false;

	DBR_GP_ValidateMBCard *pValidateMBCard=(DBR_GP_ValidateMBCard *)pData;

	//发送消息
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_LOGON,SUB_GP_VALIDATE_MBCARD,pData,wDataSize);

	return true;
}

// 补充资料
bool CAttemperEngineSink::OnDBPCProfileSuccess(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	DBO_GP_UserProfile * pUserProfile=(DBO_GP_UserProfile *)pData;

	//变量定义
	CMD_GP_UserProfile UserProfile;
	ZeroMemory(&UserProfile,sizeof(UserProfile));

	//构造数据
	UserProfile.dwUserID = pUserProfile->dwUserID;
	UserProfile.cbGender = pUserProfile->cbGender;
	UserProfile.wFaceID = pUserProfile->wFaceID;

	lstrcpyn(UserProfile.szNickName,pUserProfile->szNickName,CountArray(UserProfile.szNickName));
	lstrcpyn(UserProfile.szQQ,pUserProfile->szQQ,CountArray(UserProfile.szQQ));
	lstrcpyn(UserProfile.szMobile,pUserProfile->szMobile,CountArray(UserProfile.szMobile));
	lstrcpyn(UserProfile.szUnderWrite,pUserProfile->szUnderWrite,CountArray(UserProfile.szUnderWrite));

	//发送数据
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_LOGON,SUB_GP_PROFILE_SUCCESS,&UserProfile,sizeof(UserProfile));


	//发送列表
	if (m_pInitParameter->m_cbDelayList==TRUE)
	{
		//发送列表
		SendGameTypeInfo(dwContextID);
		SendGameKindInfo(dwContextID);
		SendGamePageInfo(dwContextID,INVALID_WORD);
		SendGameNodeInfo(dwContextID,INVALID_WORD);
		SendGameServerInfo(dwContextID,INVALID_WORD);
		m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_SERVER_LIST,SUB_GP_LIST_FINISH);
	}
	else
	{
		SendGameTypeInfo(dwContextID);
		SendGameKindInfo(dwContextID);
		SendGamePageInfo(dwContextID,0);
		m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_SERVER_LIST,SUB_GP_LIST_FINISH);
	}

	return true;
}

//补充资料失败
bool CAttemperEngineSink::OnDBPCProfileFailure(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	CMD_GP_LogonFailure LogonFailure;
	ZeroMemory(&LogonFailure,sizeof(LogonFailure));
	DBO_GP_LogonFailure * pLogonFailure=(DBO_GP_LogonFailure *)pData;

	//构造数据
	LogonFailure.lResultCode=pLogonFailure->lResultCode;
	lstrcpyn(LogonFailure.szDescribeString,pLogonFailure->szDescribeString,CountArray(LogonFailure.szDescribeString));

	//发送数据
	WORD wStringSize=CountStringBuffer(LogonFailure.szDescribeString);
	WORD wSendSize=sizeof(LogonFailure)-sizeof(LogonFailure.szDescribeString)+wStringSize;
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_LOGON,SUB_GP_PROFILE_FAILURE,&LogonFailure,wSendSize);

	//关闭连接(底层error,暂时不关闭连接)
//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);

	return true;
}

//检查昵称
bool CAttemperEngineSink::OnDBPCCheckNick(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	DBO_GP_CheckNick * pCheckNick=(DBO_GP_CheckNick *)pData;

	//变量定义
	CMD_GP_CheckNick_Res CheckNickRes;
	ZeroMemory(&CheckNickRes,sizeof(CheckNickRes));

	//构造数据
	CheckNickRes.lResultCode=pCheckNick->lResultCode;
	lstrcpyn(CheckNickRes.szDescribeString,pCheckNick->szDescribeString,CountArray(CheckNickRes.szDescribeString));

	//发送数据
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_LOGON,SUB_GP_CHECKNICK_RES,&CheckNickRes,sizeof(CheckNickRes));

	return true;
}
//用户头像
bool CAttemperEngineSink::OnDBPCUserFaceInfo(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	CMD_GP_UserFaceInfo UserFaceInfo;
	ZeroMemory(&UserFaceInfo,sizeof(UserFaceInfo));
	DBO_GP_UserFaceInfo * pUserFaceInfo=(DBO_GP_UserFaceInfo *)pData;

	//设置变量
	UserFaceInfo.wFaceID=pUserFaceInfo->wFaceID;
	UserFaceInfo.dwCustomID=pUserFaceInfo->dwCustomID;

	//发送消息
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE,SUB_GP_USER_FACE_INFO,&UserFaceInfo,sizeof(UserFaceInfo));

	return true;
}

//用户信息
bool CAttemperEngineSink::OnDBPCUserIndividual(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];
	DBO_GP_UserIndividual * pDBOUserIndividual=(DBO_GP_UserIndividual *)pData;
	CMD_GP_UserIndividual * pCMDUserIndividual=(CMD_GP_UserIndividual *)cbDataBuffer;
	CSendPacketHelper SendPacket(cbDataBuffer+sizeof(CMD_GP_UserIndividual),sizeof(cbDataBuffer)-sizeof(CMD_GP_UserIndividual));

	//设置变量
	ZeroMemory(pCMDUserIndividual,sizeof(CMD_GP_UserIndividual));

	//构造数据
	pCMDUserIndividual->dwUserID=pDBOUserIndividual->dwUserID;

	//用户信息
	if (pDBOUserIndividual->szUserNote[0]!=0)
	{
		WORD wBufferSize=CountStringBuffer(pDBOUserIndividual->szUserNote);
		SendPacket.AddPacket(pDBOUserIndividual->szUserNote,wBufferSize,DTP_GP_UI_USER_NOTE);
	}

	//真实姓名
	if (pDBOUserIndividual->szCompellation[0]!=0)
	{
		WORD wBufferSize=CountStringBuffer(pDBOUserIndividual->szCompellation);
		SendPacket.AddPacket(pDBOUserIndividual->szCompellation,wBufferSize,DTP_GP_UI_COMPELLATION);
	}

	//电话号码
	if (pDBOUserIndividual->szSeatPhone[0]!=0)
	{
		WORD wBufferSize=CountStringBuffer(pDBOUserIndividual->szSeatPhone);
		SendPacket.AddPacket(pDBOUserIndividual->szSeatPhone,wBufferSize,DTP_GP_UI_SEAT_PHONE);
	}

	//移动电话
	if (pDBOUserIndividual->szMobilePhone[0]!=0)
	{
		WORD wBufferSize=CountStringBuffer(pDBOUserIndividual->szMobilePhone);
		SendPacket.AddPacket(pDBOUserIndividual->szMobilePhone,wBufferSize,DTP_GP_UI_MOBILE_PHONE);
	}

	//联系资料
	if (pDBOUserIndividual->szQQ[0]!=0) 
	{
		WORD wBufferSize=CountStringBuffer(pDBOUserIndividual->szQQ);
		SendPacket.AddPacket(pDBOUserIndividual->szQQ,wBufferSize,DTP_GP_UI_QQ);
	}

	//电子邮件
	if (pDBOUserIndividual->szEMail[0]!=0) 
	{
		WORD wBufferSize=CountStringBuffer(pDBOUserIndividual->szEMail);
		SendPacket.AddPacket(pDBOUserIndividual->szEMail,wBufferSize,DTP_GP_UI_EMAIL);
	}

	//联系地址
	if (pDBOUserIndividual->szDwellingPlace[0]!=0)
	{
		WORD wBufferSize=CountStringBuffer(pDBOUserIndividual->szDwellingPlace);
		SendPacket.AddPacket(pDBOUserIndividual->szDwellingPlace,wBufferSize,DTP_GP_UI_DWELLING_PLACE);
	}

	//发送消息
	WORD wSendSize=sizeof(CMD_GP_UserIndividual)+SendPacket.GetDataSize();
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE,SUB_GP_USER_INDIVIDUAL,cbDataBuffer,wSendSize);

	return true;
}

//银行信息
bool CAttemperEngineSink::OnDBPCUserInsureInfo(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	DBO_GP_UserInsureInfo * pUserInsureInfo=(DBO_GP_UserInsureInfo *)pData;

	//变量定义
	CMD_GP_UserInsureInfo UserInsureInfo;
	ZeroMemory(&UserInsureInfo,sizeof(UserInsureInfo));

	//构造数据
	UserInsureInfo.wRevenueTake=pUserInsureInfo->wRevenueTake;
	UserInsureInfo.wRevenueTransfer=pUserInsureInfo->wRevenueTransfer;
	UserInsureInfo.wServerID=pUserInsureInfo->wServerID;
	UserInsureInfo.lUserScore=pUserInsureInfo->lUserScore;
	UserInsureInfo.lUserInsure=pUserInsureInfo->lUserInsure;
	UserInsureInfo.lTransferPrerequisite=pUserInsureInfo->lTransferPrerequisite;
	UserInsureInfo.dwDiamondCount = pUserInsureInfo->dwDiamondCount;

	//发送数据
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE,SUB_GP_USER_INSURE_INFO,&UserInsureInfo,sizeof(UserInsureInfo));

	//关闭连接(底层error,暂时不去关闭)
//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);

	return true;
}
//转账记录
bool CAttemperEngineSink::OnDBPCUserTransRecord(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
    ASSERT(wDataSize==sizeof(DBR_GP_UserTransRecord));
	if (wDataSize!=sizeof(DBR_GP_UserTransRecord)) return false;

	DBR_GP_UserTransRecord *pTransRecord=(DBR_GP_UserTransRecord *)pData;
    
	CMD_GP_RealTransRecord RealTransRecord;
	ZeroMemory(&RealTransRecord,sizeof(RealTransRecord));
	RealTransRecord.dwGameID = pTransRecord->dwGameID;
	_tcscpy(RealTransRecord.szSourceAccount,pTransRecord->szSourceAccount);
	_tcscpy(RealTransRecord.szTargetAccounts,pTransRecord->szTargetAccounts);
	_tcscpy(RealTransRecord.szTime,pTransRecord->szTime);
	RealTransRecord.lSwapScore = pTransRecord->lSwapScore;
    RealTransRecord.lRevenue=pTransRecord->lRevenue;
    RealTransRecord.bOver = pTransRecord->bOver;
	RealTransRecord.dwTargetID = pTransRecord->dwTargetID;
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE,SUB_GP_TRANS_RECORD,&RealTransRecord,sizeof(RealTransRecord));
    if(pTransRecord->bOver)
    {
         //关闭连接(底层error,暂时不去关闭)
//         m_pITCPNetworkEngine->ShutDownSocket(dwContextID);
    }
    return true;
}
//银行成功
bool CAttemperEngineSink::OnDBPCUserInsureSuccess(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	DBO_GP_UserInsureSuccess * pUserInsureSuccess=(DBO_GP_UserInsureSuccess *)pData;

	//变量定义
	CMD_GP_UserInsureSuccess UserInsureSuccess;
	ZeroMemory(&UserInsureSuccess,sizeof(UserInsureSuccess));

	//设置变量
	UserInsureSuccess.dwUserID=pUserInsureSuccess->dwUserID;
	UserInsureSuccess.lUserScore=pUserInsureSuccess->lSourceScore+pUserInsureSuccess->lVariationScore;
	UserInsureSuccess.lUserInsure=pUserInsureSuccess->lSourceInsure+pUserInsureSuccess->lVariationInsure;
	lstrcpyn(UserInsureSuccess.szDescribeString,pUserInsureSuccess->szDescribeString,CountArray(UserInsureSuccess.szDescribeString));

	//发送消息
	WORD wDescribe=CountStringBuffer(UserInsureSuccess.szDescribeString);
	WORD wHeadSize=sizeof(UserInsureSuccess)-sizeof(UserInsureSuccess.szDescribeString);
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE,SUB_GP_USER_INSURE_SUCCESS,&UserInsureSuccess,wHeadSize+wDescribe);

	return true;
}

//操作失败
bool CAttemperEngineSink::OnDBPCUserInsureFailure(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	CMD_GP_UserInsureFailure UserInsureFailure;
	ZeroMemory(&UserInsureFailure,sizeof(UserInsureFailure));

	//变量定义
	DBO_GP_UserInsureFailure * pUserInsureFailure=(DBO_GP_UserInsureFailure *)pData;

	//构造数据
	UserInsureFailure.lResultCode=pUserInsureFailure->lResultCode;
	lstrcpyn(UserInsureFailure.szDescribeString,pUserInsureFailure->szDescribeString,CountArray(UserInsureFailure.szDescribeString));

	//发送数据
	WORD wDescribe=CountStringBuffer(UserInsureFailure.szDescribeString);
	WORD wHeadSize=sizeof(UserInsureFailure)-sizeof(UserInsureFailure.szDescribeString);
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE,SUB_GP_USER_INSURE_FAILURE,&UserInsureFailure,wHeadSize+wDescribe);

	//关闭连接(底层error,暂时不去关闭)
//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);

	return true;
}

//用户信息
bool CAttemperEngineSink::OnDBPCUserInsureUserInfo(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	DBO_GP_UserTransferUserInfo * pTransferUserInfo=(DBO_GP_UserTransferUserInfo *)pData;

	//变量定义
	CMD_GP_UserTransferUserInfo UserTransferUserInfo;
	ZeroMemory(&UserTransferUserInfo,sizeof(UserTransferUserInfo));

	//构造变量
	UserTransferUserInfo.dwTargetGameID=pTransferUserInfo->dwGameID;
	lstrcpyn(UserTransferUserInfo.szNickName,pTransferUserInfo->szNickName,CountArray(UserTransferUserInfo.szNickName));

	//发送数据
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE,SUB_GP_QUERY_USER_INFO_RESULT,&UserTransferUserInfo,sizeof(UserTransferUserInfo));

	return true;
}

//操作成功
bool CAttemperEngineSink::OnDBPCOperateSuccess(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	CMD_GP_OperateSuccess OperateSuccess;
	ZeroMemory(&OperateSuccess,sizeof(OperateSuccess));

	//变量定义
	DBO_GP_OperateSuccess * pOperateSuccess=(DBO_GP_OperateSuccess *)pData;

	//构造数据
	OperateSuccess.lResultCode=pOperateSuccess->lResultCode;
	lstrcpyn(OperateSuccess.szDescribeString,pOperateSuccess->szDescribeString,CountArray(OperateSuccess.szDescribeString));

	//发送数据
	WORD wDescribe=CountStringBuffer(OperateSuccess.szDescribeString);
	WORD wHeadSize=sizeof(OperateSuccess)-sizeof(OperateSuccess.szDescribeString);
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE,SUB_GP_OPERATE_SUCCESS,&OperateSuccess,wHeadSize+wDescribe);

	//关闭连接(底层error,暂时不关闭连接)
//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);

	return true;
}

//操作失败
bool CAttemperEngineSink::OnDBPCOperateFailure(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	CMD_GP_OperateFailure OperateFailure;
	ZeroMemory(&OperateFailure,sizeof(OperateFailure));

	//变量定义
	DBO_GP_OperateFailure * pOperateFailure=(DBO_GP_OperateFailure *)pData;

	//构造数据
	OperateFailure.lResultCode=pOperateFailure->lResultCode;
	lstrcpyn(OperateFailure.szDescribeString,pOperateFailure->szDescribeString,CountArray(OperateFailure.szDescribeString));

	//发送数据
	WORD wDescribe=CountStringBuffer(OperateFailure.szDescribeString);
	WORD wHeadSize=sizeof(OperateFailure)-sizeof(OperateFailure.szDescribeString);
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE,SUB_GP_OPERATE_FAILURE,&OperateFailure,wHeadSize+wDescribe);

	//关闭连接(底层error,暂时不关闭连接)
//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);

	return true;
}

// 转账回执
bool CAttemperEngineSink::OnDBPCUserTransReceipt(DWORD dwContextID,VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	CMD_GR_UserTransferReceipt UserTransferReceipt;
	ZeroMemory(&UserTransferReceipt,sizeof(UserTransferReceipt));

	//变量定义
	CMD_GR_UserTransferReceipt * pUserTransferReceipt=(CMD_GR_UserTransferReceipt *)pData;

	CopyMemory(&UserTransferReceipt, pUserTransferReceipt, wDataSize);

	LOGI("CAttemperEngineSink::OnDBUserTransferReceipt, dwRecordID="<<UserTransferReceipt.dwRecordID<<", dwSourceUserID="<<UserTransferReceipt.dwSourceUserID<<\
		", dwTargetUserID="<<UserTransferReceipt.dwTargetUserID<<", dwSourceGameID="<<UserTransferReceipt.dwSourceGameID<<", dwTargetGameID="<<UserTransferReceipt.dwTargetGameID<<\
		", szSourceNickName="<<UserTransferReceipt.szSourceNickName<<", szTargetNickName="<<UserTransferReceipt.szTargetNickName<<\
		", lTransferScore="<<UserTransferReceipt.lTransferScore<<", lRevenueScore="<<UserTransferReceipt.lRevenueScore);

	//构造数据
//	OperateSuccess.lResultCode=pOperateSuccess->lResultCode;
//	lstrcpyn(OperateSuccess.szDescribeString,pOperateSuccess->szDescribeString,CountArray(OperateSuccess.szDescribeString));

	//发送数据
//	WORD wDescribe=CountStringBuffer(OperateSuccess.szDescribeString);
//	WORD wHeadSize=sizeof(OperateSuccess)-sizeof(OperateSuccess.szDescribeString);
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE, SUB_GP_USER_TRANSFER_RECEIPT, &UserTransferReceipt,sizeof(UserTransferReceipt));

	//关闭连接(底层error,暂时不关闭连接)
//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);

	return true;
}

// 读取魅力兑换配置成功
bool CAttemperEngineSink::OnDBPExchangeLovelinessInfo(DWORD dwContextID,VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	CMD_GP_ExchangeLovelinessInfo ExchangeLovelinessInfo;
	ZeroMemory(&ExchangeLovelinessInfo,sizeof(ExchangeLovelinessInfo));

	//变量定义
	DBO_GP_ExchangeLovelinessInfo * pExchangeLovelinessInfo=(DBO_GP_ExchangeLovelinessInfo *)pData;

	// 拷贝数据
	ExchangeLovelinessInfo.dwUserID = pExchangeLovelinessInfo->dwUserID;
	ExchangeLovelinessInfo.dwLoveliness = pExchangeLovelinessInfo->dwLoveliness;						// 用户魅力
	ExchangeLovelinessInfo.dwAvailbleAmount = pExchangeLovelinessInfo->dwAvailbleAmount;					// 可兑换魅力
	ExchangeLovelinessInfo.dwFinalAmount = pExchangeLovelinessInfo->dwFinalAmount;						// 实际能得到的货币(可兑换魅力 * 兑换率)
	lstrcpyn(ExchangeLovelinessInfo.szTips,pExchangeLovelinessInfo->szTips,CountArray(ExchangeLovelinessInfo.szTips));
	lstrcpyn(ExchangeLovelinessInfo.szErr,pExchangeLovelinessInfo->szErr,CountArray(ExchangeLovelinessInfo.szErr));

//	WORD wTips=CountStringBuffer(ExchangeLovelinessInfo.szTips);
//	WORD wErr=CountStringBuffer(ExchangeLovelinessInfo.szErr);
//	WORD wHeadSize=sizeof(ExchangeLovelinessInfo)-sizeof(ExchangeLovelinessInfo.szTips)-sizeof(ExchangeLovelinessInfo.szErr);
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE, SUB_GP_EXCHANGE_LOVELINESS_INFO, &ExchangeLovelinessInfo, sizeof(ExchangeLovelinessInfo));

	//关闭连接(底层error,暂时不关闭连接)
//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);

	return true;
}

// 魅力兑换操作返回
bool CAttemperEngineSink::OnDBPExchangeLoveliness(DWORD dwContextID,VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	CMD_GP_ExchangeLovelinessResult ExchangeLovelinessResult;
	ZeroMemory(&ExchangeLovelinessResult,sizeof(ExchangeLovelinessResult));

	//变量定义
	DBO_GP_ExchangeLoveliness * pExchangeLoveliness=(DBO_GP_ExchangeLoveliness *)pData;

	// 拷贝数据
	ExchangeLovelinessResult.dwUserID = pExchangeLoveliness->dwUserID;
	ExchangeLovelinessResult.dwLoveliness = pExchangeLoveliness->dwLoveliness;
	ExchangeLovelinessResult.lScore = pExchangeLoveliness->lScore;				
	ExchangeLovelinessResult.lInsureScore = pExchangeLoveliness->lInsureScore;	
	ExchangeLovelinessResult.lResultCode=pExchangeLoveliness->lResultCode;
	lstrcpyn(ExchangeLovelinessResult.szDescribeString,pExchangeLoveliness->szDescribeString,CountArray(ExchangeLovelinessResult.szDescribeString));

	LOGI("CAttemperEngineSink::OnDBPExchangeLoveliness, dwUserID="<<pExchangeLoveliness->dwUserID<<", dwLoveliness="<<pExchangeLoveliness->dwLoveliness<<\
		", lScore="<<pExchangeLoveliness->lScore<<", lInsureScore="<<pExchangeLoveliness->lInsureScore<<", lResultCode="<<pExchangeLoveliness->lResultCode<<\
		", szDescribeString="<<pExchangeLoveliness->szDescribeString);

	m_pITCPNetworkEngine->SendData(dwContextID,MDM_GP_USER_SERVICE, SUB_GP_EXCHANGE_LOVELINESS_RESULT, &ExchangeLovelinessResult, sizeof(ExchangeLovelinessResult));

	//关闭连接(底层error,暂时不关闭连接)
//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);
	return true;
}

//登录成功
bool CAttemperEngineSink::OnDBMBLogonSuccess(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	LOGI("CAttemperEngineSink::OnDBMBLogonSuccess");
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	DBO_MB_LogonSuccess * pDBOLogonSuccess=(DBO_MB_LogonSuccess *)pData;

	//变量定义
// 	CMD_MB_LogonSuccess LogonSuccess;
// 	ZeroMemory(&LogonSuccess,sizeof(LogonSuccess));


	BYTE cbDataBuffer[SOCKET_TCP_PACKET];
	CMD_MB_LogonSuccess * pMBLogonSuccess = (CMD_MB_LogonSuccess *)cbDataBuffer;
	memset(pMBLogonSuccess, 0, sizeof(CMD_MB_LogonSuccess));

	WORD wHeadSize = sizeof(CMD_MB_LogonSuccess);
	CSendPacketHelper SendPacket(cbDataBuffer + wHeadSize, sizeof(cbDataBuffer) - wHeadSize);

	//构造数据
	pMBLogonSuccess->wFaceID = pDBOLogonSuccess->wFaceID;
	pMBLogonSuccess->cbGender = pDBOLogonSuccess->cbGender;
	pMBLogonSuccess->dwGameID = pDBOLogonSuccess->dwGameID;
	pMBLogonSuccess->dwUserID = pDBOLogonSuccess->dwUserID;
	pMBLogonSuccess->dwExperience = pDBOLogonSuccess->dwExperience;
	pMBLogonSuccess->dwLoveLiness = pDBOLogonSuccess->dwLoveLiness;
	pMBLogonSuccess->lUserScore = pDBOLogonSuccess->lUserScore;							//用户金币
	pMBLogonSuccess->lUserInsure = pDBOLogonSuccess->lUserInsure;							//用户银行	.
	lstrcpyn(pMBLogonSuccess->szAccounts, pDBOLogonSuccess->szAccounts, CountArray(pMBLogonSuccess->szAccounts));
	lstrcpyn(pMBLogonSuccess->szNickName, pDBOLogonSuccess->szNickName, CountArray(pMBLogonSuccess->szNickName));
	pMBLogonSuccess->dwDiamondCount = pDBOLogonSuccess->dwDiamondCount;

	// 打印日志
	LOGI("CAttemperEngineSink::OnDBMBLogonSuccess UserID=" << pMBLogonSuccess->dwUserID << ", UserScore=" << pMBLogonSuccess->lUserScore <<
		", lUserInsure=" << pMBLogonSuccess->lUserInsure << ", AreaID=" << pDBOLogonSuccess->dwAreaID);

	if (pDBOLogonSuccess->cbMemberOrder != 0)
	{
		DTP_MB_MemberInfo MemberInfo;
		memset(&MemberInfo, 0, sizeof(MemberInfo));
		MemberInfo.cbMemberOrder = pDBOLogonSuccess->cbMemberOrder;
		SendPacket.AddPacket(&MemberInfo, sizeof(MemberInfo), DTP_MB_MEMBER_INFO);
	}

	if (pDBOLogonSuccess->szAgentInfo[0] != 0)
	{
		DTP_MB_AgentInfo AgentInfo;
		memset(&AgentInfo, 0, sizeof(AgentInfo));
		_sntprintf(AgentInfo.szAgentInfo, sizeof(AgentInfo.szAgentInfo), pDBOLogonSuccess->szAgentInfo);
		SendPacket.AddPacket(&AgentInfo, sizeof(AgentInfo), DTP_MB_AGENT_INFO);
	}

	//登录成功
	//登录成功
	WORD wSendSize = SendPacket.GetDataSize() + wHeadSize;
	m_pITCPNetworkEngine->SendData(dwContextID, MDM_MB_LOGON, SUB_MB_LOGON_SUCCESS, cbDataBuffer, wSendSize);

	//发送房间
	WORD wIndex=LOWORD(dwContextID);
	SendMobileTypeInfo(dwContextID);
	SendMobileKindInfo(dwContextID, INVALID_WORD, pDBOLogonSuccess->dwAreaID, pDBOLogonSuccess->wPlatformID);
	SendMobileServerInfo(dwContextID, INVALID_WORD, pDBOLogonSuccess->dwAreaID, pDBOLogonSuccess->wPlatformID);
	SendMobileKindInfoEx(dwContextID, INVALID_WORD, pDBOLogonSuccess->dwAreaID, pDBOLogonSuccess->wPlatformID);
	SendCustomTablePropertyConfig(dwContextID, INVALID_WORD, pDBOLogonSuccess->dwAreaID);
	// 发送已经加入的自定义桌子信息
	if (pDBOLogonSuccess->wServerID != 0 && pDBOLogonSuccess->szSecret[0] != 0)
	{
		SendUserCustomTableInfo(dwContextID, pDBOLogonSuccess->wServerID, pDBOLogonSuccess->szSecret, pDBOLogonSuccess->bLockedInTable);
	}
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_MB_SERVER_LIST,SUB_MB_LIST_FINISH);

	return true;
}

//登录失败
bool CAttemperEngineSink::OnDBMBLogonFailure(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	//变量定义
	CMD_MB_LogonFailure LogonFailure;
	ZeroMemory(&LogonFailure,sizeof(LogonFailure));
	DBO_MB_LogonFailure * pLogonFailure=(DBO_MB_LogonFailure *)pData;

	//构造数据
	LogonFailure.lResultCode=pLogonFailure->lResultCode;
	lstrcpyn(LogonFailure.szDescribeString,pLogonFailure->szDescribeString,CountArray(LogonFailure.szDescribeString));

	//发送数据
	WORD wStringSize=CountStringBuffer(LogonFailure.szDescribeString);
	WORD wSendSize=sizeof(LogonFailure)-sizeof(LogonFailure.szDescribeString)+wStringSize;
	LOGD("CAttemperEngineSink::OnDBMBLogonFailure, SendData \n");
	m_pITCPNetworkEngine->SendData(dwContextID,MDM_MB_LOGON,SUB_MB_LOGON_FAILURE,&LogonFailure,wSendSize);

	//关闭连接(底层有问题,关闭socket可能导致消息还未发送成功便关闭)
//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);

	return true;
}

// 签到成功
bool CAttemperEngineSink::OnDBMBSignInCheckSuccess(DWORD dwContextID,VOID* pData,WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	DBO_MB_SignInCheck* DBOSignInCheck = (DBO_MB_SignInCheck*)pData;

	CMD_MB_SignInCheck SignInCheck;
	memset(&SignInCheck, 0, sizeof(SignInCheck));
	SignInCheck.dwErrorCode = DBOSignInCheck->dwErrorCode;
	SignInCheck.dwCheckDay = DBOSignInCheck->dwCheckDay;
//	m_pITCPNetworkEngine->SendData(dwContextID,MDM_MB_LOGON,SUB_MB_SIGN_IN_CHECK,&SignInCheck,sizeof(SignInCheck));

	return true;
}

// 读取的关于客服的配置消息
bool CAttemperEngineSink::OnDBMBCustomServiceMessage(DWORD dwContextID,VOID* pData,WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	CMD_MB_SystemMessage* pDBOSystemMessage = (CMD_MB_SystemMessage*)pData;

	CMD_MB_SystemMessage SystemMessage;
	memcpy(&SystemMessage, pDBOSystemMessage, sizeof(SystemMessage));

	//数据属性
	WORD wHeadSize=sizeof(SystemMessage)-sizeof(SystemMessage.szString);
	WORD wSendSize=wHeadSize+CountStringBuffer(SystemMessage.szString);

	m_pITCPNetworkEngine->SendData(dwContextID, MDM_MB_SYSTEM_MESSAGE, SUB_MB_CUSTOM_SERVICE_MESSAGE, &SystemMessage, wSendSize);
	
	return true;
}

// 读取关于充值的配置消息
bool CAttemperEngineSink::OnDBMBRechargeMessage(DWORD dwContextID,VOID* pData,WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID)<m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter+LOWORD(dwContextID))->dwSocketID!=dwContextID) return true;

	CMD_MB_SystemMessage* pDBOSystemMessage = (CMD_MB_SystemMessage*)pData;

	CMD_MB_SystemMessage SystemMessage;
	memcpy(&SystemMessage, pDBOSystemMessage, sizeof(SystemMessage));

	//数据属性
	WORD wHeadSize=sizeof(SystemMessage)-sizeof(SystemMessage.szString);
	WORD wSendSize=wHeadSize+CountStringBuffer(SystemMessage.szString);

	m_pITCPNetworkEngine->SendData(dwContextID,MDM_MB_SYSTEM_MESSAGE, SUB_MB_RECHARGE_MESSAGE, &SystemMessage, wSendSize);

	return true;
}

// 加入自定义桌子
bool CAttemperEngineSink::OnDBUserCustomTableSuccess(DWORD dwContextID, VOID* pData, WORD wDataSize)
{
	LOGI("CAttemperEngineSink::OnDBUserCustomTableSuccess");
	DBO_GR_UserCustomTableSuccess* pUserCustomTableSuccess = (DBO_GR_UserCustomTableSuccess*)pData;

	CMD_MB_UserCustomTableSuccess UserCustomTableSuccess;
	UserCustomTableSuccess.wServerID = pUserCustomTableSuccess->wServerID;
	lstrcpyn(UserCustomTableSuccess.szSecret, pUserCustomTableSuccess->szSecret, CountArray(UserCustomTableSuccess.szSecret));
	UserCustomTableSuccess.bLockedInTable = pUserCustomTableSuccess->bLockedInTable;
	UserCustomTableSuccess.dwDiamondCount = pUserCustomTableSuccess->dwUserPropertyCount;
	m_pITCPNetworkEngine->SendData(dwContextID, MDM_GP_USER_SERVICE, SUB_MB_USER_CUSTOM_TABLE_SUCCESS, &UserCustomTableSuccess, sizeof(UserCustomTableSuccess));

	return true;
}

// 加入自定义桌子失败
bool CAttemperEngineSink::OnDBUserCustomTableFailed(DWORD dwContextID, VOID* pData, WORD wDataSize)
{
	LOGI("CAttemperEngineSink::OnDBUserCustomTableFailed");
	DBO_GR_UserCustomTableFailure* pUserCustomTableFailure = (DBO_GR_UserCustomTableFailure*)pData;

	CMD_MB_UserCustomTableFailed UserCustomTableFailed;
	UserCustomTableFailed.lErrorCode = pUserCustomTableFailure->lResultCode;
	lstrcpyn(UserCustomTableFailed.szDescribeString, pUserCustomTableFailure->szDescribeString, CountArray(UserCustomTableFailed.szDescribeString));
	m_pITCPNetworkEngine->SendData(dwContextID, MDM_GP_USER_SERVICE, SUB_MB_USER_CUSTOM_TABLE_FAILED, &UserCustomTableFailed, sizeof(UserCustomTableFailed));
	return true;
}

// 钻石操作成功
bool CAttemperEngineSink::OnDBUserDiamondSuccess(DWORD dwContextID, VOID* pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID) < m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter + LOWORD(dwContextID))->dwSocketID != dwContextID) return true;

	//变量定义
	DBO_MB_UserDiamondSuccess * pUserUserDiamondSuccess = (DBO_MB_UserDiamondSuccess *)pData;

	//变量定义
	CMD_MB_UserDiamondSuccess UserDiamondSuccess;
	ZeroMemory(&UserDiamondSuccess, sizeof(UserDiamondSuccess));

	//设置变量
	UserDiamondSuccess.dwUserID = pUserUserDiamondSuccess->dwUserID;
	UserDiamondSuccess.dwDiamondCount = pUserUserDiamondSuccess->dwDiamondCount;
	lstrcpyn(UserDiamondSuccess.szDescribeString, pUserUserDiamondSuccess->szDescribeString, CountArray(UserDiamondSuccess.szDescribeString));

	//发送消息
	WORD wDescribe = CountStringBuffer(UserDiamondSuccess.szDescribeString);
	WORD wHeadSize = sizeof(UserDiamondSuccess) - sizeof(UserDiamondSuccess.szDescribeString);
	m_pITCPNetworkEngine->SendData(dwContextID, MDM_GP_USER_SERVICE, SUB_MB_USER_DIAMOND_SUCCESS, &UserDiamondSuccess, wHeadSize + wDescribe);

	return true;
}

// 钻石操作失败
bool CAttemperEngineSink::OnDBUserDiamondFialed(DWORD dwContextID, VOID* pData, WORD wDataSize)
{
	//判断在线
	ASSERT(LOWORD(dwContextID) < m_pInitParameter->m_wMaxConnect);
	if ((m_pBindParameter + LOWORD(dwContextID))->dwSocketID != dwContextID) return true;

	//变量定义
	CMD_MB_UserDiamondFailure UserDiamondFailure;
	ZeroMemory(&UserDiamondFailure, sizeof(UserDiamondFailure));

	//变量定义
	DBO_MB_UserDiamondFailure * pUserDiamondFailure = (DBO_MB_UserDiamondFailure *)pData;

	//构造数据
	UserDiamondFailure.lErrorCode = pUserDiamondFailure->lResultCode;
	lstrcpyn(UserDiamondFailure.szDescribeString, pUserDiamondFailure->szDescribeString, CountArray(UserDiamondFailure.szDescribeString));

	//发送数据
	WORD wDescribe = CountStringBuffer(UserDiamondFailure.szDescribeString);
	WORD wHeadSize = sizeof(UserDiamondFailure) - sizeof(UserDiamondFailure.szDescribeString);
	m_pITCPNetworkEngine->SendData(dwContextID, MDM_GP_USER_SERVICE, SUB_MB_USER_DIAMOND_FAILURE, &UserDiamondFailure, wHeadSize + wDescribe);

	//关闭连接(底层error,暂时不去关闭)
	//	m_pITCPNetworkEngine->ShutDownSocket(dwContextID);

	return true;
}

//游戏种类
bool CAttemperEngineSink::OnDBPCGameTypeItem(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//效验参数
	ASSERT(wDataSize%sizeof(DBO_GP_GameType)==0);
	if (wDataSize%sizeof(DBO_GP_GameType)!=0) return false;

	//变量定义
	WORD wItemCount=wDataSize/sizeof(DBO_GP_GameType);
	DBO_GP_GameType * pGameType=(DBO_GP_GameType *)pData;

	//更新数据
	for (WORD i=0;i<wItemCount;i++)
	{
		//变量定义
		tagGameType GameType;
		ZeroMemory(&GameType,sizeof(GameType));

		//构造数据
		GameType.wTypeID=(pGameType+i)->wTypeID;
		GameType.wJoinID=(pGameType+i)->wJoinID;
		GameType.wSortID=(pGameType+i)->wSortID;
		lstrcpyn(GameType.szTypeName,(pGameType+i)->szTypeName,CountArray(GameType.szTypeName));

		//插入列表
		m_ServerListManager.InsertGameType(&GameType);
	}

	return true;
}

//游戏类型
bool CAttemperEngineSink::OnDBPCGameKindItem(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//效验参数
	ASSERT(wDataSize%sizeof(DBO_GP_GameKind)==0);
	if (wDataSize%sizeof(DBO_GP_GameKind)!=0) return false;

	//变量定义
	WORD wItemCount=wDataSize/sizeof(DBO_GP_GameKind);
	DBO_GP_GameKind * pGameKind=(DBO_GP_GameKind *)pData;

	//更新数据
	for (WORD i=0;i<wItemCount;i++)
	{
		//变量定义
		tagGameKind GameKind;
		ZeroMemory(&GameKind,sizeof(GameKind));

		//构造数据
		GameKind.wTypeID=(pGameKind+i)->wTypeID;
		GameKind.wJoinID=(pGameKind+i)->wJoinID;
		GameKind.wSortID=(pGameKind+i)->wSortID;
		GameKind.wKindID=(pGameKind+i)->wKindID;
		GameKind.wGameID=(pGameKind+i)->wGameID;
		GameKind.dwOnLineCount=m_ServerListManager.CollectOnlineInfo((pGameKind+i)->wKindID);
		GameKind.dwFullCount=m_ServerListManager.CollectFullCount((pGameKind + i)->wKindID);
		lstrcpyn(GameKind.szKindName,(pGameKind+i)->szKindName,CountArray(GameKind.szKindName));
		lstrcpyn(GameKind.szProcessName,(pGameKind+i)->szProcessName,CountArray(GameKind.szProcessName));

		//插入列表
		m_ServerListManager.InsertGameKind(&GameKind);
	}

	return true;
}

//游戏节点
bool CAttemperEngineSink::OnDBPCGameNodeItem(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//效验参数
	ASSERT(wDataSize%sizeof(DBO_GP_GameNode)==0);
	if (wDataSize%sizeof(DBO_GP_GameNode)!=0) return false;

	//变量定义
	WORD wItemCount=wDataSize/sizeof(DBO_GP_GameNode);
	DBO_GP_GameNode * pGameNode=(DBO_GP_GameNode *)pData;

	//更新数据
	for (WORD i=0;i<wItemCount;i++)
	{
		//变量定义
		tagGameNode GameNode;
		ZeroMemory(&GameNode,sizeof(GameNode));

		//构造数据
		GameNode.wKindID=(pGameNode+i)->wKindID;
		GameNode.wJoinID=(pGameNode+i)->wJoinID;
		GameNode.wSortID=(pGameNode+i)->wSortID;
		GameNode.wNodeID=(pGameNode+i)->wNodeID;
		lstrcpyn(GameNode.szNodeName,(pGameNode+i)->szNodeName,CountArray(GameNode.szNodeName));

		//插入列表
		m_ServerListManager.InsertGameNode(&GameNode);
	}

	return true;
}

//游戏定制
bool CAttemperEngineSink::OnDBPCGamePageItem(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//效验参数
	ASSERT(wDataSize%sizeof(DBO_GP_GamePage)==0);
	if (wDataSize%sizeof(DBO_GP_GamePage)!=0) return false;

	//变量定义
	WORD wItemCount=wDataSize/sizeof(DBO_GP_GamePage);
	DBO_GP_GamePage * pGamePage=(DBO_GP_GamePage *)pData;

	//更新数据
	for (WORD i=0;i<wItemCount;i++)
	{
		//变量定义
		tagGamePage GamePage;
		ZeroMemory(&GamePage,sizeof(GamePage));

		//构造数据
		GamePage.wKindID=(pGamePage+i)->wKindID;
		GamePage.wNodeID=(pGamePage+i)->wNodeID;
		GamePage.wSortID=(pGamePage+i)->wSortID;
		GamePage.wPageID=(pGamePage+i)->wPageID;
		GamePage.wOperateType=(pGamePage+i)->wOperateType;
		lstrcpyn(GamePage.szDisplayName,(pGamePage+i)->szDisplayName,CountArray(GamePage.szDisplayName));

		//插入列表
		m_ServerListManager.InsertGamePage(&GamePage);
	}

	return true;
}

//区域ID相关的GameKindItem
bool CAttemperEngineSink::OnDBMBAreaGameKindItem(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//效验参数
	ASSERT(wDataSize%sizeof(DBO_MB_AreaGameKind) == 0);
	if (wDataSize%sizeof(DBO_MB_AreaGameKind) != 0) return false;

	//变量定义
	WORD wItemCount = wDataSize / sizeof(DBO_MB_AreaGameKind);
	DBO_MB_AreaGameKind * pAreaGameKind = (DBO_MB_AreaGameKind *)pData;

	// 清除已有数据
	m_mapAreaGameKind.clear();

	//更新数据
	for (WORD i = 0; i < wItemCount; i++)
	{
		//变量定义
		tagAreaGameKind AreaGameKind;
		ZeroMemory(&AreaGameKind, sizeof(AreaGameKind));

		//构造数据
		AreaGameKind.dwAreaID = (pAreaGameKind + i)->dwAreaID;
		AreaGameKind.wSortID = (pAreaGameKind + i)->wSortID;
		AreaGameKind.wKindID = (pAreaGameKind + i)->wKindID;
		AreaGameKind.wPlatformID = (pAreaGameKind + i)->wPlatformID;
// 		AreaGameKind.cbPcVisiable = (pAreaGameKind + i)->cbPcVisiable;
// 		AreaGameKind.cbAppVisiable = (pAreaGameKind + i)->cbAppVisiable;

		LOGI("CAttemperEngineSink::OnDBMBAreaGameKindItem, AreaID=" << AreaGameKind.dwAreaID << ", KindID=" << AreaGameKind.wKindID << \
			", SortID=" << AreaGameKind.wSortID << ", PlatformID=" << AreaGameKind.wPlatformID);

		//插入列表
		map<DWORD, vector<tagAreaGameKind> >::iterator iter = m_mapAreaGameKind.find(AreaGameKind.dwAreaID);
		if (iter != m_mapAreaGameKind.end())
		{
			iter->second.push_back(AreaGameKind);
		}
		else
		{
			vector<tagAreaGameKind> vectAreaGameKind;
			vectAreaGameKind.push_back(AreaGameKind);
			m_mapAreaGameKind.insert(make_pair(AreaGameKind.dwAreaID, vectAreaGameKind));
		}
	}

	return true;
}

//区域ID相关的GameServerItem
bool CAttemperEngineSink::OnDBMBAreaGameServerItem(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//效验参数
	ASSERT(wDataSize%sizeof(DBO_MB_AreaGameServer) == 0);
	if (wDataSize%sizeof(DBO_MB_AreaGameServer) != 0) return false;

	//变量定义
	WORD wItemCount = wDataSize / sizeof(DBO_MB_AreaGameServer);
	DBO_MB_AreaGameServer * pAreaGameKind = (DBO_MB_AreaGameServer *)pData;

	// 清除已有数据
	m_mapAreaGameServer.clear();

	//更新数据
	for (WORD i = 0; i < wItemCount; i++)
	{
		//变量定义
		tagAreaGameServer AreaGameServer;
		ZeroMemory(&AreaGameServer, sizeof(AreaGameServer));

		//构造数据
		AreaGameServer.dwAreaID = (pAreaGameKind + i)->dwAreaID;
		AreaGameServer.wSortID = (pAreaGameKind + i)->wSortID;
		AreaGameServer.wServerID = (pAreaGameKind + i)->wServerID;
		AreaGameServer.wPlatformID = (pAreaGameKind + i)->wPlatformID;
		_tcsncpy(AreaGameServer.szServerName, (pAreaGameKind + i)->szServerName, sizeof(AreaGameServer.szServerName));

		//插入列表
		map<DWORD, vector<tagAreaGameServer> >::iterator iter = m_mapAreaGameServer.find(AreaGameServer.dwAreaID);
		if (iter != m_mapAreaGameServer.end())
		{
			iter->second.push_back(AreaGameServer);
		}
		else
		{
			vector<tagAreaGameServer> vectAreaGameServer;
			vectAreaGameServer.push_back(AreaGameServer);
			m_mapAreaGameServer.insert(make_pair(AreaGameServer.dwAreaID, vectAreaGameServer));
		}
	}
	return true;
}

// APP相关的资源列表
bool CAttemperEngineSink::OnDBMBGameKindItemEx(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//效验参数
	ASSERT(wDataSize%sizeof(DBO_MB_GameKindEx) == 0);
	if (wDataSize%sizeof(DBO_MB_GameKindEx) != 0) return false;

	//变量定义
	WORD wItemCount = wDataSize / sizeof(DBO_MB_GameKindEx);
	DBO_MB_GameKindEx * pGameKindEx = (DBO_MB_GameKindEx *)pData;

	// 清除已有数据
	m_mapGameKindEx.clear();

	//更新数据
	for (WORD i = 0; i < wItemCount; i++)
	{
		//变量定义
		tagGameKindEx GameKindEx;
		ZeroMemory(&GameKindEx, sizeof(GameKindEx));

		//构造数据
		GameKindEx.wKindID = (pGameKindEx + i)->wKindID;
		GameKindEx.dwAppVersion = (pGameKindEx + i)->dwAppVersion;
		_tcsncpy(GameKindEx.szAppDownloadURL, (pGameKindEx + i)->szAppDownloadURL, sizeof(GameKindEx.szAppDownloadURL));

		LOGI("CAttemperEngineSink::OnDBMBGameKindItemEx, wKindID=" << GameKindEx.wKindID << ", dwAppVersion=" << GameKindEx.dwAppVersion << ", AppDownloadURL=" << GameKindEx.szAppDownloadURL);

		//插入列表
		map<WORD, tagGameKindEx >::iterator iter = m_mapGameKindEx.find(GameKindEx.wKindID);
		if (iter != m_mapGameKindEx.end())
		{
			iter->second = GameKindEx;;
		}
		else
		{
			m_mapGameKindEx.insert(make_pair(GameKindEx.wKindID, GameKindEx));
		}
	}

	return true;
}

// 自建桌子,消耗道具和局数配置
bool CAttemperEngineSink::OnDBMBCustomTablePropertyConfig(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//效验参数
	ASSERT(wDataSize%sizeof(DBO_MB_CustomTablePropertyConfig) == 0);
	if (wDataSize%sizeof(DBO_MB_CustomTablePropertyConfig) != 0) return false;

	//变量定义
	WORD wItemCount = wDataSize / sizeof(DBO_MB_CustomTablePropertyConfig);
	DBO_MB_CustomTablePropertyConfig * pPropertyConfig = (DBO_MB_CustomTablePropertyConfig *)pData;

	// 清除已有数据
	m_mapCustomTablePropertyConfig.clear();

	//更新数据
	for (WORD i = 0; i < wItemCount; i++)
	{
		WORD	wKindID = (pPropertyConfig + i)->wKindID;										// 游戏类型标识
		WORD	wPropertyConsumeCount = (pPropertyConfig + i)->wPropertyConsumeCount;			// 道具消耗数量
		WORD	wRoundCount = (pPropertyConfig + i)->wRoundCount;								// 对应的局数
		//插入列表
		map<WORD, tagCustomTablePropertyConfig>::iterator iter = m_mapCustomTablePropertyConfig.find(wKindID);
		if (iter != m_mapCustomTablePropertyConfig.end())
		{
			iter->second.wKindID = wKindID;
			iter->second.szPropertyConsumeCount[1] = wPropertyConsumeCount;
			iter->second.szRoundCount[1] = wRoundCount;
		}
		else
		{
			//变量定义
			tagCustomTablePropertyConfig CustomTablePropertyConfig;
			ZeroMemory(&CustomTablePropertyConfig, sizeof(CustomTablePropertyConfig));

			CustomTablePropertyConfig.wKindID = wKindID;
			CustomTablePropertyConfig.szPropertyConsumeCount[0] = wPropertyConsumeCount;
			CustomTablePropertyConfig.szRoundCount[0] = wRoundCount;

			m_mapCustomTablePropertyConfig.insert(make_pair(wKindID, CustomTablePropertyConfig));
		}
	}

	return true;
}

//游戏列表
bool CAttemperEngineSink::OnDBPCGameListResult(DWORD dwContextID, VOID * pData, WORD wDataSize)
{
	//效验参数
	ASSERT(wDataSize==sizeof(DBO_GP_GameListResult));
	if (wDataSize!=sizeof(DBO_GP_GameListResult)) return false;

	//变量定义
	DBO_GP_GameListResult * pGameListResult=(DBO_GP_GameListResult *)pData;

	//消息处理
	if (pGameListResult->cbSuccess==TRUE)
	{
		//清理列表
		m_ServerListManager.CleanKernelItem();

		//事件通知
		CP_ControlResult ControlResult;
		ControlResult.cbSuccess=ER_SUCCESS;
		SendUIControlPacket(UI_LOAD_DB_LIST_RESULT,&ControlResult,sizeof(ControlResult));

		//设置时间
		ASSERT(m_pITimerEngine!=NULL);
		m_pITimerEngine->SetTimer(IDI_LOAD_GAME_LIST,m_pInitParameter->m_wLoadListTime*1000L,1,0);
	}
	else
	{
		//构造提示
		TCHAR szDescribe[128]=TEXT("");
		_sntprintf(szDescribe,CountArray(szDescribe),TEXT("服务器列表加载失败，%ld 秒后将重新加载"),m_pInitParameter->m_wReLoadListTime);

		//提示消息
		CTraceService::TraceString(szDescribe,TraceLevel_Warning);

		//设置时间
		ASSERT(m_pITimerEngine!=NULL);
		m_pITimerEngine->SetTimer(IDI_LOAD_GAME_LIST,m_pInitParameter->m_wReLoadListTime*1000L,1,0);
	}

	return true;
}

//版本检测
bool CAttemperEngineSink::CheckPlazaVersion(BYTE cbDeviceType, DWORD dwPlazaVersion, DWORD dwSocketID, bool bCheckLowVer)
{
	//变量定义
	bool bMustUpdate=false;
	bool bAdviceUpdate=false;
	DWORD dwVersion=VERSION_PLAZA;

	//手机版本
	if(cbDeviceType >= DEVICE_TYPE_IPAD) dwVersion=VERSION_MOBILE_IOS;
	else if(cbDeviceType >= DEVICE_TYPE_IPHONE) dwVersion=VERSION_MOBILE_IOS;
	else if(cbDeviceType >= DEVICE_TYPE_ITOUCH) dwVersion=VERSION_MOBILE_IOS;
	else if(cbDeviceType >= DEVICE_TYPE_ANDROID) dwVersion=VERSION_MOBILE_ANDROID;
	else if(cbDeviceType == DEVICE_TYPE_PC) dwVersion=VERSION_PLAZA;

	//版本判断
	if (bCheckLowVer && GetSubVer(dwPlazaVersion)<GetSubVer(dwVersion)) bAdviceUpdate=true;
	if (GetMainVer(dwPlazaVersion)!=GetMainVer(dwVersion)) bMustUpdate=true;
	if (GetProductVer(dwPlazaVersion)!=GetProductVer(dwVersion)) bMustUpdate=true;

	//升级判断
	if ((bMustUpdate==true)||(bAdviceUpdate==true))
	{
		//变量定义
		CMD_GP_UpdateNotify UpdateNotify;
		ZeroMemory(&UpdateNotify,sizeof(UpdateNotify));

		//变量定义
		UpdateNotify.cbMustUpdate=bMustUpdate;
		UpdateNotify.cbAdviceUpdate=bAdviceUpdate;
		UpdateNotify.dwCurrentVersion=dwVersion;

		//发送消息
		if (cbDeviceType == DEVICE_TYPE_PC)
		{
			// PC更新提示
			m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_LOGON,SUB_GP_UPDATE_NOTIFY,&UpdateNotify,sizeof(UpdateNotify));
		}
		else
		{
			// 手机更新提示(手机中的6103和6603需要提示更新,6703之后的版本由网站控制)
			if (dwPlazaVersion == PROCESS_VERSION(1,0,3) || dwPlazaVersion == PROCESS_VERSION(2,0,3) || dwPlazaVersion == PROCESS_VERSION(3,0,3) || dwPlazaVersion == PROCESS_VERSION(4,0,3) ||
				dwPlazaVersion == PROCESS_VERSION(5,0,3) || dwPlazaVersion == PROCESS_VERSION(6,0,3))
			{
				m_pITCPNetworkEngine->SendData(dwSocketID,MDM_MB_LOGON,SUB_GP_UPDATE_NOTIFY,&UpdateNotify,sizeof(UpdateNotify));
			}
			else
			{
				return true;
			}
		}
		
		//中断判断
		if (bMustUpdate==true) 
		{
			//关闭连接(底层error,暂时不关闭连接)
//			m_pITCPNetworkEngine->ShutDownSocket(dwSocketID);
			return false;
		}
	}

	return true;
}

//发送请求
bool CAttemperEngineSink::SendUIControlPacket(WORD wRequestID, VOID * pData, WORD wDataSize)
{
	//发送数据
	CServiceUnits * pServiceUnits=CServiceUnits::g_pServiceUnits;
	pServiceUnits->PostControlRequest(wRequestID,pData,wDataSize);

	return true;
}

// DeviceType转平台ID
WORD CAttemperEngineSink::DeviceTypeToPlatformID(BYTE cbDeviceType)
{
	if (cbDeviceType == DEVICE_TYPE_PC)
	{
		return CC_PLATFORM_WIN32;
	}
	else if (cbDeviceType == DEVICE_TYPE_ANDROID)
	{
		return CC_PLATFORM_ANDROID;
	}
	else if (cbDeviceType == DEVICE_TYPE_ITOUCH)
	{
		return CC_PLATFORM_IOS;
	}
	else if (cbDeviceType == DEVICE_TYPE_IPHONE)
	{
		return CC_PLATFORM_IOS;
	}
	else if (cbDeviceType == DEVICE_TYPE_IPAD)
	{
		return CC_PLATFORM_IOS;
	}
	else
	{
		return CC_PLATFORM_UNKNOWN;
	}
}


//发送类型
VOID CAttemperEngineSink::SendGameTypeInfo(DWORD dwSocketID)
{
	//网络数据
	WORD wSendSize=0;
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];

	//枚举数据
	POSITION Position=NULL;
	CGameTypeItem * pGameTypeItem=NULL;

	//枚举数据
	for (DWORD i=0;i<m_ServerListManager.GetGameTypeCount();i++)
	{
		//发送数据
		if ((wSendSize+sizeof(tagGameType))>sizeof(cbDataBuffer))
		{
			m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_TYPE,cbDataBuffer,wSendSize);
			wSendSize=0;
		}

		//获取数据
		pGameTypeItem=m_ServerListManager.EmunGameTypeItem(Position);
		if (pGameTypeItem==NULL) break;

		//拷贝数据
		CopyMemory(cbDataBuffer+wSendSize,&pGameTypeItem->m_GameType,sizeof(tagGameType));
		wSendSize+=sizeof(tagGameType);
	}

	//发送剩余
	if (wSendSize>0) m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_TYPE,cbDataBuffer,wSendSize);

	return;
}

//发送种类
VOID CAttemperEngineSink::SendGameKindInfo(DWORD dwSocketID)
{
	//网络数据
	WORD wSendSize=0;
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];

	//枚举数据
	POSITION Position=NULL;
	CGameKindItem * pGameKindItem=NULL;

	//枚举数据
	for (DWORD i=0;i<m_ServerListManager.GetGameKindCount();i++)
	{
		//发送数据
		if ((wSendSize+sizeof(tagGameKind))>sizeof(cbDataBuffer))
		{
			m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_KIND,cbDataBuffer,wSendSize);
			wSendSize=0;
		}

		//获取数据
		pGameKindItem=m_ServerListManager.EmunGameKindItem(Position);
		if (pGameKindItem==NULL) break;

		//拷贝数据
		CopyMemory(cbDataBuffer+wSendSize,&pGameKindItem->m_GameKind,sizeof(tagGameKind));
		wSendSize+=sizeof(tagGameKind);
	}

	//发送剩余
	if (wSendSize>0) m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_KIND,cbDataBuffer,wSendSize);

	return;
}

//发送节点
VOID CAttemperEngineSink::SendGameNodeInfo(DWORD dwSocketID, WORD wKindID)
{
	//网络数据
	WORD wSendSize=0;
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];

	//枚举数据
	POSITION Position=NULL;
	CGameNodeItem * pGameNodeItem=NULL;

	//枚举数据
	for (DWORD i=0;i<m_ServerListManager.GetGameNodeCount();i++)
	{
		//发送数据
		if ((wSendSize+sizeof(tagGameNode))>sizeof(cbDataBuffer))
		{
			m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_NODE,cbDataBuffer,wSendSize);
			wSendSize=0;
		}

		//获取数据
		pGameNodeItem=m_ServerListManager.EmunGameNodeItem(Position);
		if (pGameNodeItem==NULL) break;

		//拷贝数据
		if ((wKindID==INVALID_WORD)||(pGameNodeItem->m_GameNode.wKindID==wKindID))
		{
			CopyMemory(cbDataBuffer+wSendSize,&pGameNodeItem->m_GameNode,sizeof(tagGameNode));
			wSendSize+=sizeof(tagGameNode);
		}
	}

	//发送剩余
	if (wSendSize>0) m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_NODE,cbDataBuffer,wSendSize);

	return;
}

//发送定制
VOID CAttemperEngineSink::SendGamePageInfo(DWORD dwSocketID, WORD wKindID)
{
	//网络数据
	WORD wSendSize=0;
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];

	//枚举数据
	POSITION Position=NULL;
	CGamePageItem * pGamePageItem=NULL;

	//枚举数据
	for (DWORD i=0;i<m_ServerListManager.GetGamePageCount();i++)
	{
		//发送数据
		if ((wSendSize+sizeof(tagGamePage))>sizeof(cbDataBuffer))
		{
			m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_PAGE,cbDataBuffer,wSendSize);
			wSendSize=0;
		}

		//获取数据
		pGamePageItem=m_ServerListManager.EmunGamePageItem(Position);
		if (pGamePageItem==NULL) break;

		//拷贝数据
		if ((wKindID==INVALID_WORD)||(pGamePageItem->m_GamePage.wKindID==wKindID))
		{
			CopyMemory(cbDataBuffer+wSendSize,&pGamePageItem->m_GamePage,sizeof(tagGamePage));
			wSendSize+=sizeof(tagGamePage);
		}
	}

	//发送剩余
	if (wSendSize>0) m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_PAGE,cbDataBuffer,wSendSize);

	return;
}

//发送房间
VOID CAttemperEngineSink::SendGameServerInfo(DWORD dwSocketID, WORD wKindID)
{
	//网络数据
	WORD wSendSize=0;
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];

	//枚举数据
	POSITION Position=NULL;
	CGameServerItem * pGameServerItem=NULL;

	//枚举数据
	for (DWORD i=0;i<m_ServerListManager.GetGameServerCount();i++)
	{
		//发送数据
		if ((wSendSize+sizeof(tagGameServer))>sizeof(cbDataBuffer))
		{
			m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_SERVER,cbDataBuffer,wSendSize);
			wSendSize=0;
		}

		//获取数据
		pGameServerItem=m_ServerListManager.EmunGameServerItem(Position);
		if (pGameServerItem==NULL) break;

		//拷贝数据
		if ((wKindID==INVALID_WORD)||(pGameServerItem->m_GameServer.wKindID==wKindID))
		{
			CopyMemory(cbDataBuffer+wSendSize,&pGameServerItem->m_GameServer,sizeof(tagGameServer));
			wSendSize+=sizeof(tagGameServer);
		}
	}

	//发送剩余
	if (wSendSize>0) m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_LIST_SERVER,cbDataBuffer,wSendSize);

	if(m_wAVServerPort!=0 && m_dwAVServerAddr!=0)
	{
		//变量定义
		tagAVServerOption AVServerOption;
		AVServerOption.wAVServerPort=m_wAVServerPort;
		AVServerOption.dwAVServerAddr=m_dwAVServerAddr;

		//发送配置
		m_pITCPNetworkEngine->SendData(dwSocketID,MDM_GP_SERVER_LIST,SUB_GP_VIDEO_OPTION,&AVServerOption,sizeof(AVServerOption));
	};

	return;
}

//发送类型
VOID CAttemperEngineSink::SendMobileTypeInfo(DWORD dwSocketID)
{
	//网络数据
	WORD wSendSize=0;
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];

	//枚举数据
	POSITION Position=NULL;
	CGameTypeItem * pGameTypeItem=NULL;

	//枚举数据
	for (DWORD i=0;i<m_ServerListManager.GetGameTypeCount();i++)
	{
		//发送数据
		if ((wSendSize+sizeof(tagGameType))>sizeof(cbDataBuffer))
		{
			m_pITCPNetworkEngine->SendData(dwSocketID,MDM_MB_SERVER_LIST,SUB_MB_LIST_TYPE,cbDataBuffer,wSendSize);
			wSendSize=0;
		}

		//获取数据
		pGameTypeItem=m_ServerListManager.EmunGameTypeItem(Position);
		if (pGameTypeItem==NULL) break;

		//拷贝数据
		CopyMemory(cbDataBuffer+wSendSize,&pGameTypeItem->m_GameType,sizeof(tagGameType));
		wSendSize+=sizeof(tagGameType);
	}

	//发送剩余
	if (wSendSize>0)
		m_pITCPNetworkEngine->SendData(dwSocketID,MDM_MB_SERVER_LIST,SUB_MB_LIST_TYPE,cbDataBuffer,wSendSize);
}

//发送种类
VOID CAttemperEngineSink::SendMobileKindInfo(DWORD dwSocketID, WORD wModuleID, DWORD dwAreaID /* = INVALID_DWORD */, WORD wPlatformID/* = CC_PLATFORM_UNKNOWN*/)
{
	LOGI("CAttemperEngineSink::SendMobileKindInfo, wModuleID=" << wModuleID << ", dwAreaID=" << dwAreaID << ", wPlatformID=" << wPlatformID);
	//网络数据
	WORD wSendSize = 0;
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];

	//枚举数据
	POSITION Position = NULL;
	CGameKindItem * pGameKindItem = NULL;

	//枚举数据
	for (DWORD i = 0; i<m_ServerListManager.GetGameKindCount(); i++)
	{
		//发送数据
		if ((wSendSize + sizeof(tagGameKind))>sizeof(cbDataBuffer))
		{
			m_pITCPNetworkEngine->SendData(dwSocketID, MDM_MB_SERVER_LIST, SUB_MB_LIST_KIND, cbDataBuffer, wSendSize);
			wSendSize = 0;
		}

		//获取数据
		pGameKindItem = m_ServerListManager.EmunGameKindItem(Position);
		if (pGameKindItem == NULL) break;

		//拷贝数据
		auto iter = m_mapAreaGameKind.find(dwAreaID);
		if (dwAreaID == INVALID_DWORD || iter == m_mapAreaGameKind.end())
		{
			// 不筛选AreaID
			if ((wModuleID == INVALID_WORD) || (pGameKindItem->m_GameKind.wKindID == wModuleID))
			{
				// 不筛选ModuleID
				CopyMemory(cbDataBuffer + wSendSize, &pGameKindItem->m_GameKind, sizeof(tagGameKind));
				wSendSize += sizeof(tagGameKind);
			}
		}
		else
		{
			// 有需要筛选的AreaID
			// 输出筛选的数据
			if ((wModuleID == INVALID_WORD) || (pGameKindItem->m_GameKind.wKindID == wModuleID))
			{
				for (auto v : iter->second)
				{
					if ((v.wPlatformID == CC_PLATFORM_UNKNOWN) || (v.wPlatformID == wPlatformID))
					{
						if (v.wKindID == pGameKindItem->m_GameKind.wKindID)
						{
							// SortID需要采用新表中的数据
							tagGameKind gamekind;
							CopyMemory(&gamekind, &pGameKindItem->m_GameKind, sizeof(tagGameKind));
							if (v.wSortID != 0)
							{
								// 非0才采用新的值
								gamekind.wSortID = v.wSortID;
							}
							CopyMemory(cbDataBuffer + wSendSize, &gamekind, sizeof(tagGameKind));
							wSendSize += sizeof(tagGameKind);
							break;
						}
					}
				}
			}
		}
	}

	//发送剩余
	if (wSendSize>0) m_pITCPNetworkEngine->SendData(dwSocketID,MDM_MB_SERVER_LIST,SUB_MB_LIST_KIND,cbDataBuffer,wSendSize);

	return;
}

//发送房间
VOID CAttemperEngineSink::SendMobileServerInfo(DWORD dwSocketID, WORD wModuleID, DWORD dwAreaID /* = INVALID_DWORD */, WORD wPlatformID/* = CC_PLATFORM_UNKNOWN*/)
{
	//网络数据
	WORD wSendSize=0;
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];

	//枚举数据
	POSITION Position=NULL;
	CGameServerItem * pGameServerItem=NULL;

	//枚举数据
	for (DWORD i=0;i<m_ServerListManager.GetGameServerCount();i++)
	{
		//发送数据
		if ((wSendSize+sizeof(tagGameServer))>sizeof(cbDataBuffer))
		{
			m_pITCPNetworkEngine->SendData(dwSocketID,MDM_MB_SERVER_LIST,SUB_MB_LIST_SERVER,cbDataBuffer,wSendSize);
			wSendSize=0;
		}

		//获取数据
		pGameServerItem=m_ServerListManager.EmunGameServerItem(Position);
		if (pGameServerItem==NULL) break;

		//拷贝数据
		auto iter = m_mapAreaGameServer.find(dwAreaID);
		if (dwAreaID == INVALID_DWORD || iter == m_mapAreaGameServer.end())
		{
			// 输出全部数据
			if ((wModuleID == INVALID_WORD) || (pGameServerItem->m_GameServer.wServerID == wModuleID))
			{
				CopyMemory(cbDataBuffer + wSendSize, &pGameServerItem->m_GameServer, sizeof(tagGameServer));
				wSendSize += sizeof(tagGameServer);
			}
		}
		else
		{
			// 有需要筛选的AreaID
			// 输出筛选的数据
			if ((wModuleID == INVALID_WORD) || (pGameServerItem->m_GameServer.wServerID == wModuleID))
			{
				for (auto v : iter->second)
				{
					if ((v.wPlatformID == CC_PLATFORM_UNKNOWN) || (v.wPlatformID == wPlatformID))
					{
						if (v.wServerID == pGameServerItem->m_GameServer.wServerID)
						{
							tagGameServer gameserver;
							CopyMemory(&gameserver, &pGameServerItem->m_GameServer, sizeof(tagGameServer));
							if (v.wSortID != 0)
							{
								// 非0才采用新的值
								gameserver.wSortID = v.wSortID;
							}
							if (_tcsclen(v.szServerName) != 0)
							{
								// 非空才采用新的值
								_tcsncpy(gameserver.szServerName, v.szServerName, sizeof(gameserver.szServerName));
							}
							CopyMemory(cbDataBuffer + wSendSize, &gameserver, sizeof(tagGameServer));
							wSendSize += sizeof(tagGameServer);
						}
					}
				}
			}
		}
	}

	//发送剩余
	if (wSendSize>0)
		m_pITCPNetworkEngine->SendData(dwSocketID,MDM_MB_SERVER_LIST,SUB_MB_LIST_SERVER,cbDataBuffer,wSendSize);

	return;
}

// 发送GameKind扩展信息
VOID CAttemperEngineSink::SendMobileKindInfoEx(DWORD dwSocketID, WORD wModuleID, DWORD dwAreaID/* = INVALID_DWORD*/, WORD wPlatformID/* = CC_PLATFORM_UNKNOWN*/)
{
	LOGI("CAttemperEngineSink::SendMobileKindInfoEx, wModuleID=" << wModuleID << ", dwAreaID=" << dwAreaID);
	//网络数据
	WORD wSendSize = 0;
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];

	//枚举数据
	POSITION Position = NULL;
	CGameKindItem * pGameKindItem = NULL;

	//枚举数据
	for (DWORD i = 0; i<m_ServerListManager.GetGameKindCount(); i++)
	{
		//发送数据
		if ((wSendSize + sizeof(tagGameKindEx))>sizeof(cbDataBuffer))
		{
			m_pITCPNetworkEngine->SendData(dwSocketID, MDM_MB_SERVER_LIST, SUB_MB_LIST_KIND_EX, cbDataBuffer, wSendSize);
			wSendSize = 0;
		}

		//获取数据
		pGameKindItem = m_ServerListManager.EmunGameKindItem(Position);
		if (pGameKindItem == NULL) break;

		//拷贝数据
		auto iter = m_mapAreaGameKind.find(dwAreaID);
		if (dwAreaID == INVALID_DWORD || iter == m_mapAreaGameKind.end())
		{
			// 输出全部数据
			if ((wModuleID == INVALID_WORD) || (pGameKindItem->m_GameKind.wKindID == wModuleID))
			{
				auto iterex = m_mapGameKindEx.find(pGameKindItem->m_GameKind.wKindID);
				if (iterex != m_mapGameKindEx.end())
				{
					CopyMemory(cbDataBuffer + wSendSize, &(iterex->second), sizeof(tagGameKindEx));
					wSendSize += sizeof(tagGameKindEx);
				}
			}
		}
		else
		{
			// 有需要筛选的AreaID
			// 输出筛选的数据
			if ((wModuleID == INVALID_WORD) || (pGameKindItem->m_GameKind.wKindID == wModuleID))
			{
				for (auto v : iter->second)
				{
					if ((v.wPlatformID == CC_PLATFORM_UNKNOWN) || (v.wPlatformID == wPlatformID))
					{
						if (v.wKindID == pGameKindItem->m_GameKind.wKindID)
						{
							auto iterex = m_mapGameKindEx.find(v.wKindID);
							if (iterex != m_mapGameKindEx.end())
							{
								CopyMemory(cbDataBuffer + wSendSize, &(iterex->second), sizeof(tagGameKindEx));
								wSendSize += sizeof(tagGameKindEx);
							}
						}
					}
				}
			}
		}
	}

	//发送剩余
	if (wSendSize > 0) m_pITCPNetworkEngine->SendData(dwSocketID, MDM_MB_SERVER_LIST, SUB_MB_LIST_KIND_EX, cbDataBuffer, wSendSize);
}

// 发送加入自定义桌子的信息
VOID CAttemperEngineSink::SendUserCustomTableInfo(DWORD dwSocketID, WORD wServerID, TCHAR szSecret[LEN_CUSTOMTABLEPASSWORD], bool bLockedInTable)
{
	CMD_MB_UserCustomTableSuccess UserCustomTableSuccess;
	UserCustomTableSuccess.wServerID = wServerID;
	lstrcpyn(UserCustomTableSuccess.szSecret, szSecret, CountArray(UserCustomTableSuccess.szSecret));
	UserCustomTableSuccess.bLockedInTable = bLockedInTable;
	m_pITCPNetworkEngine->SendData(dwSocketID, MDM_GP_USER_SERVICE, SUB_MB_USER_CUSTOM_TABLE_SUCCESS, &UserCustomTableSuccess, sizeof(UserCustomTableSuccess));
}

// 发送自建桌子房间的道具消耗信息
VOID CAttemperEngineSink::SendCustomTablePropertyConfig(DWORD dwSocketID, WORD wModuleID, DWORD dwAreaID /*= INVALID_DWORD*/, WORD wPlatformID /*= CC_PLATFORM_UNKNOWN*/)
{
	LOGI("CAttemperEngineSink::SendCustomTablePropertyConfig");
	//网络数据
	WORD wSendSize = 0;
	BYTE cbDataBuffer[SOCKET_TCP_PACKET];

	//枚举数据
	POSITION Position = NULL;
	CGameKindItem * pGameKindItem = NULL;

	//枚举数据
	for (DWORD i = 0; i<m_ServerListManager.GetGameKindCount(); i++)
	{
		//发送数据
		if ((wSendSize + sizeof(tagCustomTablePropertyConfig))>sizeof(cbDataBuffer))
		{
			m_pITCPNetworkEngine->SendData(dwSocketID, MDM_MB_SERVER_LIST, SUB_MB_LIST_PROP_CONFIG, cbDataBuffer, wSendSize);
			wSendSize = 0;
		}

		//获取数据
		pGameKindItem = m_ServerListManager.EmunGameKindItem(Position);
		if (pGameKindItem == NULL) break;

		//拷贝数据
		auto iter = m_mapAreaGameKind.find(dwAreaID);
		if (dwAreaID == INVALID_DWORD || iter == m_mapAreaGameKind.end())
		{
			// 输出全部数据
			if ((wModuleID == INVALID_WORD) || (pGameKindItem->m_GameKind.wKindID == wModuleID))
			{
				auto iterex = m_mapCustomTablePropertyConfig.find(pGameKindItem->m_GameKind.wKindID);
				if (iterex != m_mapCustomTablePropertyConfig.end())
				{
					CopyMemory(cbDataBuffer + wSendSize, &(iterex->second), sizeof(tagCustomTablePropertyConfig));
					wSendSize += sizeof(tagCustomTablePropertyConfig);
				}
			}
		}
		else
		{
			// 有需要筛选的AreaID
			// 输出筛选的数据
			if ((wModuleID == INVALID_WORD) || (pGameKindItem->m_GameKind.wKindID == wModuleID))
			{
				for (auto v : iter->second)
				{
					if ((v.wPlatformID == CC_PLATFORM_UNKNOWN) || (v.wPlatformID == wPlatformID))
					{
						if (v.wKindID == pGameKindItem->m_GameKind.wKindID)
						{
							auto iterex = m_mapCustomTablePropertyConfig.find(v.wKindID);
							if (iterex != m_mapCustomTablePropertyConfig.end())
							{
								CopyMemory(cbDataBuffer + wSendSize, &(iterex->second), sizeof(tagCustomTablePropertyConfig));
								wSendSize += sizeof(tagCustomTablePropertyConfig);
							}
						}
					}
				}
			}
		}
	}

	//发送剩余
	if (wSendSize > 0)
	{
		m_pITCPNetworkEngine->SendData(dwSocketID, MDM_MB_SERVER_LIST, SUB_MB_LIST_PROP_CONFIG, cbDataBuffer, wSendSize);
	}
}

//////////////////////////////////////////////////////////////////////////////////
