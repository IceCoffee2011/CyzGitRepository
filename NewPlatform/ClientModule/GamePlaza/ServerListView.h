#ifndef SERVER_LIST_VIEW_HEAD_FILE
#define SERVER_LIST_VIEW_HEAD_FILE

#pragma once

#include "Stdafx.h"
#include "ServerListData.h"
#include "LastGameServerCtrl.h"

//////////////////////////////////////////////////////////////////////////////////

//数组说明
typedef CMap<WORD,WORD,UINT,UINT>	CGameImageMap;						//游戏图标
typedef CList<WORD>	                CLastGameServerList;				//游戏房间

//////////////////////////////////////////////////////////////////////////////////

//房间列表
class CServerListView : public CTreeCtrl, public IServerListDataSink/*, public ILastGameServerCtrlSink */
{
	//位置变量
protected:
	INT								m_nXScroll;							//滚动偏移
	INT								m_nYScroll;							//滚动偏移

	//列表句柄
protected:
	HTREEITEM						m_TreeListRoot;						//顶项句柄
	HTREEITEM						m_TreeAssistant;					//辅助句柄

	//资源变量
protected:
	CFont							m_FontBold;							//粗体字体
	CFont							m_FontUnderLine;					//带下划线的字体
	CFont							m_FontNormal;						//普通字体
	CBitImage						m_ImageTypeBkgnd;					//类型的底图
	CPngImage						m_ImageArrow1;						//箭头图标（大的类型）
	CPngImage						m_ImageArrow2;						//箭头图标（游戏）
	CPngImage						m_ImageItemLine;					//装饰线
	CPngImage						m_ImageStarLevel;					//游戏星级
	CPngImage						m_ImageHotLevel;					//游戏热度
	CPngImage						m_ImageVolumnFlag;					//房间人数
	CSkinScrollBar					m_SkinScrollBar;					//滚动条类

	//资源变量
protected:
	ILastGameServerSink*			m_pILastGameServerSink;				

	//资源变量
protected:
	CImageList						m_ImageList;						//图片资源
	CGameImageMap					m_GameImageMap;						//图形索引
	CLastGameServerList             m_LastPlayGameList;                 //最近玩过游戏

	//辅助变量
protected:
	HTREEITEM						m_hItemMouseHover;					//盘旋子项
	HTREEITEM						m_hTreeClickExpand;					//单击树项
//	CGameTypeItem                   m_LastServerItem;                   //最近游戏

	//字体变量
protected:

	//函数定义
public:
	//构造函数
	CServerListView();
	//析构函数
	virtual ~CServerListView();

	//状态通知
public:
	//获取通知
	virtual VOID OnGameItemFinish();
	//获取通知
	virtual VOID OnGameKindFinish(WORD wKindID);
	//更新通知
	virtual VOID OnGameItemUpdateFinish();

	//更新通知
public:
	//插入通知
	virtual VOID OnGameItemInsert(CGameListItem * pGameListItem);
	//更新通知
	virtual VOID OnGameItemUpdate(CGameListItem * pGameListItem);
	//删除通知
	virtual VOID OnGameItemDelete(CGameListItem * pGameListItem);

//	// 最近游戏控件位置移动
// public:
// 	virtual VOID OnMoveLastGameServerCtrl(int nWidth, int nHeight);

	//重载函数
protected:
	//命令函数
	virtual BOOL OnCommand(WPARAM wParam, LPARAM lParam);
	//窗口函数
	virtual LRESULT DefWindowProc(UINT uMessage, WPARAM wParam, LPARAM lParam);

	//功能函数
public:
	//快速通道
	VOID InitAssistantItem();
	//配置函数
	VOID InitServerTreeView();

	//功能函数
public:
	//获取选择
	HTREEITEM GetCurrentSelectItem(bool bOnlyText);
	//添加记录
	void AddLastPlayGame(WORD wServerID, CGameServerItem *pGameServerItem);
	//判断记录
	bool IsLastPlayGame(WORD wServerID);
	//枚举记录
	HTREEITEM EmunGameServerItem(HTREEITEM hParentItem, WORD wServerID);
	//子项为空
	bool IsEmptySubitem(WORD wKindID);
	//获得房间人数状态
	int  GetLoadInfoOfServer(tagGameServer * pGameServer);

	//展开函数
public:
	//展开判断
	bool ExpandVerdict(HTREEITEM hTreeItem);
	//展开列表
	bool ExpandListItem(HTREEITEM hTreeItem);
	//展开列表
	bool ExpandListItem(CGameListItem * pGameListItem);

	//配置函数
public:
	//设置接口
	VOID SetLastGameServerSink(ILastGameServerSink * pILastGameServerSink) { m_pILastGameServerSink = pILastGameServerSink; };

	//绘画函数
private:
	//绘画子项
	VOID DrawTreeItem(CDC * pDC, CRect & rcClient, CRect & rcClipBox);
	//绘画背景
	VOID DrawTreeBack(CDC * pDC, CRect & rcClient, CRect & rcClipBox);

	//绘画树
	VOID DrawTree(CDC * pDC, CRect & rcClient, CRect & rcClipBox);

	//绘画辅助
private:
	//绘制列表项
	VOID DrawItem(CDC * pDC, CRect rcRect, HTREEITEM hTreeItem,bool bHovered, bool bSelected);
	//绘制图标
	VOID DrawListImage(CDC * pDC, CRect rcRect, HTREEITEM hTreeItem,bool bHovered, bool bSelected);
	//绘制文本
	VOID DrawItemString(CDC * pDC, CRect rcRect, HTREEITEM hTreeItem, bool bSelected);

	//图标函数
private:
	//获取图标
	UINT GetGameImageIndex(CGameKindItem * pGameKindItem);
	//获取图标
	UINT GetGameImageIndex(CGameServerItem * pGameServerItem);

	//标题函数
private:
	//获取标题
	LPCTSTR GetGameItemTitle(CGameKindItem * pGameKindItem, LPTSTR pszTitle, UINT uMaxCount);
	//获取标题
	LPCTSTR GetGameItemTitle(CGameServerItem * pGameServerItem, LPTSTR pszTitle, UINT uMaxCount);

	//辅助函数
private:
	//删除更新
	VOID DeleteUpdateItem(CGameListItem * pGameListItem);
	//修改子项
	VOID ModifyGameListItem(HTREEITEM hTreeItem, LPCTSTR pszTitle, UINT uImage);
	//插入子项
	HTREEITEM InsertInsideItem(LPCTSTR pszTitle, UINT uImage, DWORD dwInsideID, HTREEITEM hParentItem);
	//插入子项
	HTREEITEM InsertGameListItem(LPCTSTR pszTitle, UINT uImage, CGameListItem * pGameListItem, HTREEITEM hParentItem);

	//系统消息
protected:
	//重画消息
	VOID OnPaint();
	//时间消息
	VOID OnTimer(UINT nIDEvent);
	//绘画背景
	BOOL OnEraseBkgnd(CDC * pDC);
	//位置消息
	VOID OnSize(UINT nType, INT cx, INT cy);
	//光标消息
	BOOL OnSetCursor(CWnd * pWnd, UINT nHitTest, UINT uMessage);

	//列表消息
protected:
	//右键列表
	VOID OnNMRClick(NMHDR * pNMHDR, LRESULT * pResult);
	//左击列表
	VOID OnNMLClick(NMHDR * pNMHDR, LRESULT * pResult);
	//列表改变
	VOID OnTvnSelchanged(NMHDR * pNMHDR, LRESULT * pResult);
	//列表展开
//	VOID OnTvnItemexpanding(NMHDR * pNMHDR, LRESULT * pResult);

	afx_msg void OnLButtonDown(UINT nFlags, CPoint point);

	DECLARE_MESSAGE_MAP()

protected:
	//获得房间负载信息
	LPCTSTR GetLoadInfoOfServer(DWORD dwOnLineCount, DWORD dwMaxCount, LPTSTR pszBuffer, WORD wBufferSize);
	//获得房间负载信息
	LPCTSTR GetLoadInfoOfServer(tagGameServer * pGameServer, LPTSTR pszBuffer, WORD wBufferSize);
	//获得房间负载信息
	LPCTSTR GetLoadInfoOfServer(tagGameKind * pGameKind, LPTSTR pszBuffer, WORD wBufferSize);
	//加载记录
	void LoadLastPlayGame();
	//保存记录
	void SaveLastPlayGame();
public:
	afx_msg void OnLButtonDblClk(UINT nFlags, CPoint point);
};

//////////////////////////////////////////////////////////////////////////////////

#endif
